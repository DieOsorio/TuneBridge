import{j as t}from"./mui-DM0ppf3M.js";import{r as I}from"./calendar-BpW-aEGs.js";import{a3 as oe,a4 as ne,s as S,u as le,a5 as ie,a as ce,G as de,j as ue,a6 as pe,l as me,a7 as ge,c as he,k as xe,E as fe,I as O,T as be,X as we,B as F,x as ye}from"./index-Bh6NGL6n.js";import{m as je}from"./icons-DBDvTy8s.js";import"./reactPlayer-CjHFj7G4.js";import"./lottie-DTlWc_fK.js";import"./gsap-Brfk6Bdo.js";import"./filepond-DcLflJls.js";const $e=()=>{const a=oe();return ne({mutationFn:async({file:g,userId:c,postId:r,filename:i})=>{const e=`${c}/${r}/${i}`,{data:h,error:x}=await S.storage.from("post-media").upload(e,g,{cacheControl:"3600",upsert:!0});if(x)throw new Error(x.message);const{data:m}=S.storage.from("post-media").getPublicUrl(e);return m!=null&&m.publicUrl?m.publicUrl:(console.warn("getPublicUrl did not return a valid publicUrl",m),null)},onMutate:async({file:g,userId:c,postId:r,filename:i})=>{await a.cancelQueries({queryKey:["posts"]});const e=a.getQueryData(["posts"]),h={id:`temp-${Date.now()}`,url:URL.createObjectURL(g),created_at:new Date().toISOString(),userId:c,postId:r,filename:i};return a.setQueryData(["posts"],(x=[])=>[...x,h]),{previousDetails:e}},onError:(g,c,r)=>{r!=null&&r.previousDetails&&a.setQueryData(["posts"],r.previousDetails)},onSettled:(g,c)=>{a.invalidateQueries({queryKey:["posts"]})}})},Ce=()=>{var Q;const{t:a}=le("posts"),c=ie().state,r=(c==null?void 0:c.groupId)??null,{user:i}=ce(),{postId:e}=de(),h=ue(),{createPost:x,updatePost:m,fetchPost:V,deletePost:A}=pe(),U=$e(),{upsertHashtag:B}=me(),{getHashtagsByPostId:M,upsertPostHashtag:T,deletePostHashtags:K}=ge(),[b,y]=I.useState([]),[d,j]=I.useState([]),[z,P]=I.useState(!1),{register:N,handleSubmit:G,setValue:$,watch:v,reset:X,formState:{errors:E,isSubmitting:R}}=he(),f=(Q=v("newHashtag"))==null?void 0:Q.trim(),{data:u,isLoading:J,error:k}=e?V(e):{data:null,isLoading:!1,error:null},{data:H}=e?M(e):{data:[]};I.useEffect(()=>{if(e&&u&&($("title",u.title),$("content",u.content),y(u.images_urls||[]),H)){const s=H.map(n=>{var p;return((p=n==null?void 0:n.hashtags)==null?void 0:p.name)||""});j(s)}},[u,H,e,$]);const W=()=>{f&&!d.includes(f)&&d.length<5&&(j([...d,f]),$("newHashtag",""))},Y=s=>{j(d.filter(n=>n!==s))},Z=s=>{y(s)},ee=async s=>{const n=s.split("/").pop();if(!n)return;await S.storage.from("post-media").remove([n]);const p=b.filter(D=>D!==s);y(p)},te=()=>P(!0),ae=async()=>{!e||!u||(await A(e),h(r?`/group/${r}`:`/profile/${u.profile_id}`),P(!1))},se=async s=>{const{newHashtag:n,...p}=s,D=d.map(l=>l.trim()).filter(Boolean);try{let l;if(e&&u){const _=(await Promise.all(b.map(async(o,L)=>{if(!(o instanceof File))return o;const C=`${Date.now()}-${L}-${o.name}`;return await U.mutateAsync({file:o,userId:r||(i==null?void 0:i.id),postId:e,filename:C})}))).filter(o=>o!=null);await m({id:e,updatedPost:{...p,images_urls:_}}),await K({post_id:e}),l=u}else{if(!i)throw new Error("User not logged in");l=await x({...p,images_urls:[],...r?{group_id:r}:{profile_id:i.id}});const _=(await Promise.all(b.map(async(o,L)=>{if(!(o instanceof File))return o;const C=`${Date.now()}-${L}-${o.name}`;return await U.mutateAsync({file:o,userId:r||i.id,postId:l.id,filename:C})}))).filter(o=>o!=null);await m({id:l.id,updatedPost:{images_urls:_}})}const re=await Promise.all(D.map(w=>B({name:w})));await Promise.all(re.map(w=>T({post_id:l.id,hashtag_id:w.id}))),X(),y([]),j([]),h(e?r?`/group/${r}`:`/profile/${l.profile_id}`:"/explore")}catch(l){console.error("Post error:",(l==null?void 0:l.message)||l)}};if(J)return t.jsx(xe,{});if(k)return t.jsx(fe,{error:k.message});const q=/^#[\w-]+$/.test(f||"");return t.jsxs(t.Fragment,{children:[t.jsx("h2",{className:"text-2xl text-yellow-600 font-semibold text-center mb-4",children:a(e?"update.title":"create.title")}),t.jsxs("form",{onSubmit:G(se),className:"space-y-6 bg-gradient-to-r from-gray-900 p-6 rounded-lg shadow-md max-w-xl mx-auto",children:[t.jsx(O,{id:"title",label:a(`${e?"update":"create"}.labels.title`),placeholder:a(`${e?"update":"create"}.placeholders.title`),maxLength:30,watchValue:v("title"),register:N,validation:{required:a(`${e?"update":"create"}.errors.title`)},error:E.title,classForLabel:"text-gray-400 text-center md:text-left"}),t.jsx(be,{id:"content",label:a(`${e?"update":"create"}.labels.content`),placeholder:a(`${e?"update":"create"}.placeholders.content`),register:N,validation:{required:a(`${e?"update":"create"}.errors.contentRequired`),maxLength:{value:150,message:a(`${e?"update":"create"}.errors.content`)}},error:E.content,maxLength:150,watchValue:v("content"),classForLabel:"text-gray-400"}),t.jsxs("div",{className:"flex flex-col gap-2",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(O,{id:"newHashtag",label:a(`${e?"update":"create"}.labels.hashtags`),placeholder:a(`${e?"update":"create"}.placeholders.hashtags`),type:"text",register:N,maxLength:12,watchValue:v("newHashtag"),classForLabel:"!text-gray-400",className:"!flex-1"}),t.jsx("button",{type:"button",onClick:W,disabled:!f||d.length>=5||!q,className:`mt-4 p-2 rounded-full ${!f||d.length>=5||!q?"cursor-not-allowed text-emerald-900":"cursor-pointer text-emerald-500 hover:text-emerald-700"}`,children:t.jsx(je,{size:22})})]}),d.length>0&&t.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:d.map((s,n)=>t.jsxs("span",{className:"px-2 py-1 text-sm rounded bg-sky-800 text-white flex items-center gap-2",children:[s,t.jsx("button",{type:"button",onClick:()=>Y(s),className:"text-red-400 hover:text-red-600 font-bold",children:"×"})]},n))})]}),e&&b.some(s=>typeof s=="string")&&t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-2",children:a("update.labels.existingImages")}),t.jsx("div",{className:"flex flex-wrap gap-4",children:b.filter(s=>typeof s=="string").map((s,n)=>t.jsxs("div",{className:"relative",children:[t.jsx("img",{src:s,alt:`Existing post image ${n}`,className:"w-32 h-32 object-cover rounded-lg"}),t.jsx("button",{type:"button",onClick:p=>{p.stopPropagation(),ee(s)},className:"absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center",children:"×"})]},n))})]}),t.jsx(we,{amount:3,onFilesUpdate:Z,classForLabel:"text-gray-400 text-center md:text-left"}),t.jsxs("div",{className:"flex justify-center gap-4",children:[t.jsx(F,{type:"button",onClick:()=>h("/explore"),className:"!bg-gray-600 hover:!bg-gray-700",children:a(`${e?"update":"create"}.buttons.cancel`)}),t.jsx(F,{type:"submit",disabled:R,children:a(R?`${e?"update":"create"}.buttons.${e?"updating":"posting"}`:`${e?"update":"create"}.buttons.${e?"update":"post"}`)}),e&&t.jsx(F,{type:"button",onClick:te,className:"!bg-red-600 hover:!bg-red-700",children:a("update.buttons.delete")})]})]}),e&&t.jsx(ye,{isOpen:z,title:a("update.buttons.delete"),message:a("update.errors.confirmDelete"),onConfirm:ae,onCancel:()=>P(!1),confirmLabel:a("update.buttons.delete"),cancelLabel:a("update.buttons.cancel"),color:"error"})]})};export{Ce as default};
