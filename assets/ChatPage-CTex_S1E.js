import{j as e}from"./mui-DM0ppf3M.js";import{r as c}from"./calendar-BpW-aEGs.js";import{a as T,F as B,b as $,V as K,E as Q,u as R,D as ee,G as ce,j as te,W as se,c as ue,x as D,P as J,X as ge,Y as be,k as ve}from"./index-Cp_fnYYT.js";import{S as V}from"./index-CpFbDMuT.js";/* empty css                 */import{T as je,U as ye,V as we,l as Ne,a as xe,W as he,H as oe,X as de,Y as Ce,Z as _e,_ as ke}from"./icons-A8qOaPVA.js";import"./reactPlayer-CjHFj7G4.js";import"./lottie-DTlWc_fK.js";import"./gsap-Brfk6Bdo.js";import"./filepond-DcLflJls.js";const me=({isSelected:t=!1})=>{const r="#a1a1aa",i="#e4e4e7";return e.jsxs("div",{className:`flex items-center gap-3 px-4 py-2 ${t?"bg-sky-700":"bg-transparent"}`,children:[e.jsx(V,{circle:!0,width:40,height:40,baseColor:r,highlightColor:i}),e.jsx("div",{className:"flex flex-col grow",children:e.jsx(V,{height:15,width:"80%",baseColor:r,highlightColor:i})})]})},Le=({conversation:t,isSelected:r,onClick:i})=>{const{user:s}=T(),{fetchParticipants:d}=B(),{data:g=[],isLoading:f,error:u}=d(t.id),{fetchProfile:a}=$(),x=g==null?void 0:g.find(k=>k.profile_id!==(s==null?void 0:s.id)),{data:l,isLoading:v,error:n}=a((x==null?void 0:x.profile_id)??""),{unreadMessages:h}=K(),{data:m,isLoading:N}=h({conversationId:t.id,profileId:(s==null?void 0:s.id)||""});if(f||v)return e.jsx(me,{isSelected:r});if(u||n)return e.jsx(Q,{error:(u==null?void 0:u.message)||(n==null?void 0:n.message)||"Unknown error"});const j=t.is_group?t.avatar_url:l==null?void 0:l.avatar_url,C=t.is_group?t.title:l==null?void 0:l.username;return e.jsxs("div",{onClick:()=>i(t.id),className:`flex items-center gap-3 px-4 py-2 cursor-pointer transition-colors ${r?"bg-sky-700":"hover:bg-sky-950 hover:text-white"}`,children:[e.jsxs("div",{className:"relative",children:[j?e.jsx("img",{src:j,alt:"Avatar",className:"w-10 h-10 rounded-full object-cover"}):e.jsx("div",{className:"w-10 h-10 rounded-full bg-neutral-600 flex items-center justify-center text-white text-sm",children:(C==null?void 0:C.charAt(0).toUpperCase())||"?"}),!N&&(m!=null&&m.length)?e.jsx("span",{className:"absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full px-1.5",children:(m==null?void 0:m.length)??0}):null]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:`font-medium truncate ${r&&"text-white"}`,children:C||"Untitled"}),t.last_message&&e.jsx("span",{className:"text-sm text-neutral-400 truncate max-w-[180px]",children:t.last_message})]})]})},Oe=({onSelectConversation:t})=>{const{t:r}=R("chat"),{user:i}=T(),{fetchConversations:s}=ee(),{data:d,isLoading:g,error:f}=s((i==null?void 0:i.id)??""),{conversationId:u}=ce(),a=te(),[x,l]=c.useState(u),{setIsConversationListVisible:v}=se();c.useEffect(()=>{!u&&d&&d.length>0?l(d[0].id):l(u)},[u,d]);const n=h=>{l(h),a(`/chat/${h}`),v(!1),t==null||t()};return g?e.jsx(e.Fragment,{children:[...Array(3)].map((h,m)=>e.jsx(me,{},m))}):f?e.jsx(Q,{error:f.message}):e.jsx("div",{className:"w-full overflow-y-auto h-full bg-gradient-to-l from-gray-900 border-r-2 border-sky-700",children:d!=null&&d.length?d.map(h=>e.jsx(Le,{conversation:h,isSelected:x===h.id,onClick:()=>n(h.id)},h.id)):e.jsx("p",{className:"text-gray-400 p-4",children:r("list")})})};function Se({participant:t,isSelf:r,isAdmin:i,menuOpen:s,setMenuOpen:d,setConfirmDialog:g,navigate:f,t:u}){var h;const{fetchProfile:a}=$(),x=(h=a(t.profile_id))==null?void 0:h.data,l=c.useRef(null),[v,n]=c.useState(!1);return c.useEffect(()=>{s===t.profile_id&&l.current&&(l.current.getBoundingClientRect().bottom+140>window.innerHeight?n(!0):n(!1))},[s,t.profile_id]),e.jsxs("li",{className:"flex items-center justify-between py-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(J,{avatar_url:x==null?void 0:x.avatar_url,gender:x==null?void 0:x.gender,className:"!w-8 !h-8"}),e.jsx("span",{className:"text-white font-medium",children:(x==null?void 0:x.username)||t.profile_id}),e.jsx("span",{className:`ml-2 px-2 py-0.5 rounded text-xs ${t.role==="admin"?"bg-sky-700 text-white":"bg-gray-700 text-gray-200"}`,children:u(`groupOverview.role.${t.role}`)})]}),!r&&i&&e.jsxs("div",{className:"relative",children:[e.jsx("button",{ref:l,className:"p-1 rounded-full cursor-pointer hover:bg-gray-800 text-gray-300",onClick:()=>d(s===t.profile_id?null:t.profile_id),"aria-label":u("groupOverview.menu.open"),children:s===t.profile_id?e.jsx(xe,{size:20}):e.jsx(he,{size:20})}),s===t.profile_id&&e.jsx("div",{className:`absolute right-0 w-45 bg-gray-800 border border-gray-700 rounded shadow-lg z-10 ${v?"bottom-full mb-2":"mt-2"}`,children:e.jsxs("ul",{className:"py-1",children:[e.jsx("li",{children:e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-gray-700 text-white",onClick:()=>{f(`/profile/${t.profile_id}`),d(null)},children:u("groupOverview.actions.viewProfile")})}),t.role!=="admin"&&e.jsx("li",{children:e.jsx("button",{className:"w-full text-left border-t border-gray-700 px-4 py-2 text-sm hover:bg-sky-700 text-white",onClick:()=>g({open:!0,action:"promote",participant:t}),children:u("groupOverview.actions.promote")})}),e.jsx("li",{children:e.jsx("button",{className:"w-full text-left border-t border-gray-700 px-4 py-2 text-sm hover:bg-red-700 text-white",onClick:()=>g({open:!0,action:"remove",participant:t}),children:u("groupOverview.actions.remove")})})]})})]})]},t.profile_id)}function Ee({conversation:t,onClose:r}){const{user:i}=T(),[s,d]=c.useState(null),{updateConversation:g}=ee(),{fetchParticipants:f,addParticipant:u,removeParticipant:a,updateParticipantRole:x}=B(),{data:l=[]}=f(t.id),{searchProfiles:v}=$(),{t:n}=R("chat"),[h,m]=c.useState(!1),[N,b]=c.useState(t.title||""),[j,C]=c.useState(!1),[k,A]=c.useState(null),S=c.useRef(null),w=te(),[y,M]=c.useState({open:!1,action:null,participant:null}),[_,E]=c.useState(!1),{register:ae,watch:W}=ue(),X=W("searchTerm"),re=l.map(o=>o.profile_id)||[],{data:F,isLoading:z}=v(X),Y=(F==null?void 0:F.filter(o=>!re.includes(o.id)))||[],I=l.some(o=>o.profile_id===(i==null?void 0:i.id)&&o.role==="admin"),Z=async o=>{if(!(!(o!=null&&o[0])||!t.id)&&!j){C(!0);try{const L=o[0];A(URL.createObjectURL(o[0]));const O=await be(L,"chat-group-avatars",t.id,t.avatar_url??void 0,!0);O&&O!==t.avatar_url&&(await g({conversation:t,updates:{avatar_url:O}}),A(null))}finally{C(!1)}}},U=async()=>{m(!1);const o=N.trim();o&&o!==t.title&&await g({conversation:t,updates:{title:o}})},q=async()=>{y.participant&&(y.action==="promote"?await x({conversation_id:t.id,profile_id:y.participant.profile_id,role:"admin"}):y.action==="remove"&&await a({conversation_id:t.id,profile_id:y.participant.profile_id}),M({open:!1,action:null,participant:null}),d(null))},P=async()=>{E(!1),!(!t||!(i!=null&&i.id))&&(await a({conversation_id:t.id,profile_id:i.id}),r())};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-gray-900 rounded-lg shadow-lg p-6 w-full max-w-md relative",children:[e.jsx("button",{onClick:r,className:"absolute cursor-pointer top-2 right-2 text-3xl text-white","aria-label":"Close group overview",children:"âœ•"}),e.jsx("div",{className:"flex justify-start mb-4",children:e.jsxs("button",{onClick:()=>E(!0),className:"text-red-400 cursor-pointer hover:text-red-600 transition text-sm font-semibold flex items-center gap-1",title:n("header.buttons.leaveGroup"),children:[e.jsx(je,{size:18}),n("header.buttons.leaveGroup")]})}),e.jsx(D,{isOpen:_,title:n("header.leave.title"),message:n("header.leave.groupMessage"),confirmLabel:n("header.leave.confirm"),cancelLabel:n("header.leave.cancel"),onConfirm:P,onCancel:()=>E(!1),color:"error"}),e.jsxs("div",{className:"flex flex-col items-center gap-4 mb-6",children:[e.jsxs("div",{className:"relative",children:[e.jsx(J,{avatar_url:k||t.avatar_url||void 0,className:"w-20 h-20 bg-amber-600"}),I&&e.jsxs(e.Fragment,{children:[e.jsx("button",{ref:S,className:"absolute bottom-0 right-0 bg-black bg-opacity-50 p-2 rounded-full text-white hover:bg-opacity-80 transition",title:n("groupOverview.avatar.edit"),disabled:j,children:e.jsx(ye,{className:"w-5 h-5 cursor-pointer"})}),e.jsx(ge,{onFilesUpdate:Z,amount:1,triggerRef:S})]})]}),e.jsx("div",{className:"flex items-center gap-2",children:h?e.jsx("input",{type:"text",value:N,onChange:o=>b(o.target.value),onBlur:U,onKeyDown:o=>o.key==="Enter"&&U(),autoFocus:!0,className:"bg-transparent border-b border-sky-500 text-lg font-semibold text-white focus:outline-none",disabled:!I}):e.jsxs(e.Fragment,{children:[e.jsx("h2",{className:"text-xl font-bold text-white",children:N||"Untitled Group"}),I&&e.jsx(we,{onClick:()=>m(!0),className:"text-white cursor-pointer hover:text-sky-400 transition text-base",title:n("groupOverview.title.edit")})]})}),I&&e.jsxs("div",{className:"w-full mt-2",children:[e.jsx("input",{type:"text",...ae("searchTerm"),placeholder:n("header.search.placeholder"),className:"w-full p-2 rounded-md bg-neutral-800 text-white text-sm border border-neutral-600"}),z&&e.jsx("span",{className:"text-sm text-gray-400 mt-1 block",children:n("header.search.searching")}),e.jsxs("div",{className:"mt-2 flex flex-col gap-2",children:[Y.map(o=>e.jsxs("div",{className:"flex items-center gap-2 bg-gray-800 rounded p-2",children:[e.jsx(J,{avatar_url:o.avatar_url,gender:o.gender,className:"!w-8 !h-8"}),e.jsx("span",{className:"text-white font-medium",children:o.username}),e.jsx("button",{className:"ml-auto px-2 py-1 bg-sky-700 text-white rounded hover:bg-sky-800 text-xs font-semibold",onClick:()=>u({conversation_id:t.id,profile_id:o.id,role:"member"}),children:n("header.search.toggle")})]},o.id)),!z&&X&&Y.length===0&&e.jsx("span",{className:"text-sm text-gray-500",children:n("header.search.noResults")})]})]})]}),e.jsxs("div",{children:[e.jsxs("h3",{className:"text-lg font-semibold text-white mb-2 flex items-center gap-2",children:[e.jsx(Ne,{})," ",n("groupOverview.participants")]}),e.jsx("ul",{className:"divide-y divide-gray-700",children:[...new Map(l.map(o=>[o.profile_id,o])).values()].map(o=>{const L=(i==null?void 0:i.id)===o.profile_id;return e.jsx(Se,{participant:o,isSelf:L,isAdmin:I,menuOpen:s,setMenuOpen:d,setConfirmDialog:M,navigate:w,t:n},o.profile_id)})})]}),e.jsx(D,{isOpen:y.open,title:y.action==="remove"?`${n("groupOverview.actions.remove")}?`:`${n("groupOverview.actions.promote")}?`,message:"",confirmLabel:n("groupOverview.actions.confirm"),cancelLabel:n("groupOverview.actions.cancel"),onConfirm:q,onCancel:()=>M({open:!1,action:null,participant:null}),color:y.action==="remove"?"error":"primary"})]})})}const Ie=({conversationId:t})=>{var ne;const{user:r}=T(),i=(r==null?void 0:r.id)??"",{t:s}=R("chat"),{fetchConversation:d,fetchConversations:g,updateConversation:f,deleteConversation:u}=ee(),{data:a,isLoading:x,error:l}=d(t??""),{refetch:v}=g(i),{fetchParticipants:n,removeParticipant:h}=B(),m=n(t??"").data;function N(p){return p&&typeof p=="object"&&Array.isArray(p.pages)}let b=[];Array.isArray(m)?b=m:N(m)?b=m.pages.flat():m?(console.error("participantsData unexpected shape",m),b=[]):b=[];const j=b.find(p=>p.profile_id!==i),{fetchProfile:C,searchProfiles:k}=$(),{register:A,watch:S}=ue(),w=S("searchTerm"),{data:y}=k(w),M=b.map(p=>p.profile_id);y==null||y.filter(p=>!M.includes(p.id));const _=(a==null?void 0:a.is_group)??!1;b.some(p=>p.profile_id===i&&p.role==="admin"),c.useRef(null);const E=te(),[ae,W]=c.useState(!1),[X,re]=c.useState(!1),[F,z]=c.useState((a==null?void 0:a.title)??""),[Y,I]=c.useState(!1),[Z,U]=c.useState(!1),[q,P]=c.useState(!1),[o,L]=c.useState(!1),[O,H]=c.useState(!1),{isConversationListVisible:G,toggleConversationList:ie}=se(),le=b.find(p=>p.profile_id===i),fe=async()=>{try{if(U(!1),!a||!i)return;if(_){if(!le){console.error("Current user participant info missing, can't remove");return}await h({conversation_id:a.id,profile_id:i,role:le.role})}else await u(a);E("/chat"),v()}catch(p){console.error("Failed to leave conversation:",p.message)}};if(c.useEffect(()=>{_&&(W(!0),a!=null&&a.title&&z(a.title))},[_,a==null?void 0:a.title]),!t)return e.jsxs("div",{className:"flex items-center gap-4 px-4 py-2 border-b border-sky-600",children:[e.jsx("h2",{className:"text-lg font-semibold",children:s("header.noConversation.title")}),e.jsx("button",{onClick:ie,className:"md:hidden text-white bg-sky-600 text-2xl mr-2 ml-auto rounded-md p-1 cursor-pointer","aria-label":G?"Hide conversation list":"Show conversation list",title:G?"Hide conversation list":"Show conversation list",children:e.jsx(oe,{size:30})})]});if(x)return e.jsx(ve,{});if(l)return e.jsx(Q,{error:l.message});const pe=async()=>{if(a)try{await f({conversation:a,updates:{avatar_url:"/public/group.png",is_group:!0,title:s("header.group.untitled")}})}catch(p){console.error("Failed to convert to group chat:",p.message)}finally{P(!1)}};return e.jsxs("div",{className:"flex flex-col md:flex-row md:items-start md:justify-between gap-2 bg-gradient-to-l from-gray-900 px-4 py-2 border-b-2 border-sky-600",children:[e.jsxs("div",{className:"flex items-center gap-4 w-full relative",children:[a!=null&&a.avatar_url?e.jsx("div",{className:"relative",children:e.jsx("img",{src:a==null?void 0:a.avatar_url,alt:"Group Avatar",className:"w-10 h-10 bg-amber-600 rounded-full object-cover"})}):e.jsx("div",{className:"w-10 h-10 rounded-full bg-neutral-600 flex items-center justify-center text-white text-sm",children:((ne=a==null?void 0:a.title)==null?void 0:ne.charAt(0).toUpperCase())??"?"}),e.jsx("h2",{className:"text-lg font-semibold text-white",children:(a==null?void 0:a.title)??s("header.group.untitled")}),_&&e.jsxs("button",{onClick:()=>L(!0),className:"ml-auto px-2 py-1 cursor-pointer bg-sky-700 text-white rounded hover:bg-sky-800 transition text-xs font-semibold items-center gap-1 hidden md:flex",title:s("header.group.info"),children:[e.jsx(de,{size:18,className:"inline-block text-base text-gray-300"}),s("header.group.info")]}),!_&&e.jsxs("div",{className:"ml-auto relative flex items-center",children:[e.jsxs("button",{className:"p-1 w-[32px] h-[32px] rounded-full hover:bg-gray-800 cursor-pointer text-gray-300 relative",onClick:()=>H(p=>!p),"aria-label":s("header.menu.open"),children:[e.jsx("span",{className:`absolute inset-0 flex items-center justify-center transition-all duration-200 ease-in-out ${O?"opacity-0 scale-90":"opacity-100 scale-100"}`,children:e.jsx(he,{size:22})}),e.jsx("span",{className:`absolute inset-0 flex items-center justify-center transition-all duration-200 ease-in-out ${O?"opacity-100 scale-100":"opacity-0 scale-90"}`,children:e.jsx(xe,{size:22})})]}),O&&e.jsx("div",{className:"absolute right-7 mt-28 w-48 bg-gray-800 border border-gray-700 rounded shadow-lg z-10",children:e.jsxs("ul",{className:"py-1",children:[e.jsx("li",{children:e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-gray-700 text-white",onClick:()=>{j!=null&&j.profile_id&&E(`/profile/${j.profile_id}`),H(!1)},children:s("groupOverview.actions.viewProfile")})}),e.jsx("li",{children:e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm border-t border-gray-700 hover:bg-sky-700 text-white",onClick:()=>{P(!0),H(!1)},children:s("header.buttons.convertToGroup")})}),e.jsx("li",{children:e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm border-t border-gray-700 hover:bg-red-700 text-white",onClick:()=>{U(!0),H(!1)},children:s("header.buttons.leaveConversation")})})]})})]}),!_&&e.jsx(D,{isOpen:Z,title:s("header.leave.title"),message:s("header.leave.directMessage"),confirmLabel:s("header.leave.confirm"),cancelLabel:s("header.leave.cancel"),onConfirm:fe,onCancel:()=>U(!1),color:"error"}),e.jsx(D,{isOpen:q,title:s("header.convert.title"),message:s("header.convert.message"),confirmLabel:s("header.convert.confirm"),cancelLabel:s("header.convert.cancel"),onConfirm:pe,onCancel:()=>P(!1),className:"!bg-emerald-600 hover:!bg-emerald-700"}),e.jsx("button",{onClick:ie,className:"md:hidden text-white bg-sky-600 text-2xl mr-2 ml-auto rounded-md p-1","aria-label":s(G?"header.buttons.hideList":"header.buttons.showList"),title:s(G?"header.buttons.hideList":"header.buttons.showList"),children:e.jsx(oe,{size:30})})]}),_&&e.jsxs("button",{onClick:()=>L(!0),className:"mt-2 mr-auto px-2 py-1 bg-sky-700 text-white rounded hover:bg-sky-800 transition text-xs font-semibold flex items-center gap-1 md:hidden",title:s("header.group.info"),children:[e.jsx(de,{size:20,className:"inline-block text-base text-gray-300"}),s("header.group.info")]}),o&&a&&e.jsx(Ee,{conversation:a,onClose:()=>L(!1)})]})},Ue=t=>{const r=["bg-emerald-600","bg-yellow-700","bg-purple-700","bg-green-800","bg-red-800","bg-pink-800","bg-indigo-500","bg-blue-800","bg-orange-700","bg-teal-600","bg-fuchsia-800","bg-cyan-700","bg-lime-700","bg-rose-800","bg-violet-600"];let i=0;for(let d=0;d<t.length;d++)i=t.charCodeAt(d)+((i<<5)-i);const s=Math.abs(i)%r.length;return r[s]},Ae=({message:t,isMine:r})=>{const{t:i}=R("chat"),{deleteMessage:s,updateMessage:d}=K(),{fetchProfile:g}=$(),{data:f,isLoading:u}=g(t.sender_profile_id),a=Array.isArray(t.delivered_to)&&t.delivered_to.length>0,x=Array.isArray(t.read_by)&&t.read_by.length>0,l=r?"bg-sky-700 text-white":`${Ue(t.sender_profile_id)} text-white`,[v,n]=c.useState(!1),[h,m]=c.useState(t.content),[N,b]=c.useState(!1),j=c.useRef(null);c.useEffect(()=>{if(!N)return;const w=y=>{j.current&&!j.current.contains(y.target)&&b(!1)};return document.addEventListener("mousedown",w),()=>document.removeEventListener("mousedown",w)},[N]);const C=()=>{n(!0),b(!1)},k=()=>{h.trim()&&h!==t.content&&d({id:t.id,conversation_id:t.conversation_id,updatedFields:{content:h}}),n(!1)},A=()=>{m(t.content),n(!1)},S=()=>{s({id:t.id,conversation_id:t.conversation_id}),b(!1)};return e.jsxs("div",{className:`flex ${r?"justify-end":"justify-start"} space-x-2`,children:[!r&&e.jsxs("div",{className:"flex flex-col items-start max-w-xs",children:[e.jsx("span",{className:"text-xs font-medium text-sky-300 mb-1",children:u?e.jsx(V,{width:80,height:12,baseColor:"#a1a1aa",highlightColor:"#e4e4e7"}):`${(f==null?void 0:f.firstname)||"Unknown"} ${(f==null?void 0:f.lastname)||""}`.trim()}),u?e.jsx(V,{height:32,width:200,baseColor:"#a1a1aa",highlightColor:"#e4e4e7"}):e.jsx("div",{className:`${l} p-2 rounded-lg min-w-[80px] text-center`,children:t.content})]}),r&&e.jsx("div",{className:"flex flex-col items-end max-w-xs relative",children:e.jsx("div",{className:`${l} p-3 rounded-lg relative pr-6 min-w-[80px]`,children:v?e.jsx("input",{type:"text",value:h,onChange:w=>m(w.target.value),onBlur:k,onKeyDown:w=>{w.key==="Enter"&&k(),w.key==="Escape"&&A()},placeholder:i("message.edit.placeholder"),autoFocus:!0,className:"bg-sky-900 text-white border-b border-sky-400 focus:outline-none w-full px-1 rounded"}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"mr-2",children:t.content}),e.jsx("span",{className:"absolute bottom-1 right-1 text-xs text-white",children:x?e.jsx(Ce,{className:"text-green-200",title:"Read"}):a?e.jsx(_e,{className:"text-blue-200",title:"Delivered"}):null}),e.jsx("button",{className:"absolute top-1/2 -translate-y-1/2 right-1 text-white hover:text-sky-400 p-1",onClick:()=>b(w=>!w),"aria-label":"Message options",children:e.jsx(ke,{size:18})}),N&&e.jsxs("div",{ref:j,className:"absolute z-10 right-5 top-6 bg-gray-900 border border-sky-700 rounded shadow-lg py-1 w-37 flex flex-col",children:[e.jsx("button",{className:"px-4 py-2 text-left hover:bg-gray-800 text-sm text-red-400",onClick:S,children:i("message.delete.title")}),e.jsx("div",{className:"border-t border-sky-700"}),e.jsx("button",{className:"px-4 py-2 text-left hover:bg-gray-800 text-sm text-yellow-500",onClick:C,children:i("message.edit.title")})]})]})})})]})},Me=({messages:t,profileId:r})=>{const i=Array.isArray(t)?t.filter(Boolean):[];return e.jsx("div",{className:"space-y-4",children:i.length>0&&i.map(s=>{const d=s.sender_profile_id===r;return e.jsx(Ae,{message:s,isMine:d},s.id||s.tempId||Math.random())})})},Pe=({conversationId:t,senderId:r})=>{const{t:i}=R("chat"),[s,d]=c.useState(""),{insertMessage:g}=K(),{fetchParticipants:f}=B(),{data:u=[]}=f(t),a=async l=>{if(l.preventDefault(),!s.trim())return;const v=(u==null?void 0:u.map(n=>n.profile_id).filter(n=>n!==r))??[];await g({content:s,sender_profile_id:r,conversation_id:t,delivered_to:v}),d("")},x=l=>{l.key==="Enter"&&!l.shiftKey&&(l.preventDefault(),a(l))};return e.jsxs("form",{onSubmit:a,className:"flex items-center space-x-2",children:[e.jsx("textarea",{rows:1,value:s,onChange:l=>d(l.target.value),onKeyDown:x,placeholder:i("input.placeholder"),className:"flex-1 resize-none rounded-lg border border-neutral-700 bg-neutral-950 text-white p-2 outline-none focus:ring-1 focus:ring-neutral-500"}),e.jsx("button",{type:"submit",className:"bg-sky-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-sky-700 transition",children:i("input.button")})]})},Te=()=>{const{conversationId:t}=ce(),{user:r}=T(),i=!!t&&!!(r!=null&&r.id),{fetchMessages:s,markMessagesAsRead:d,unreadMessages:g,messagesRealtime:f}=K();f(t??"");const{data:u=[]}=s(t??""),{data:a=[]}=g({conversationId:t??"",profileId:(r==null?void 0:r.id)??""});c.useEffect(()=>{if(i&&a&&a.length>0&&d){const l=a.map(v=>v.id);d({messageIds:l,profileId:r.id,conversationId:t})}},[i,a,d,r==null?void 0:r.id,t]);const x=Array.isArray(u)?u.filter(l=>l&&l.sender_profile_id):[];return e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsx(Ie,{conversationId:t}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4",children:e.jsx(Me,{messages:i?x:[],profileId:(r==null?void 0:r.id)??""})}),e.jsx("div",{className:"p-4",children:t&&(r==null?void 0:r.id)&&e.jsx(Pe,{conversationId:t,senderId:r.id})})]})},We=()=>{const{isConversationListVisible:t,setIsConversationListVisible:r}=se(),i=()=>{r(!1)};return e.jsxs("div",{className:"flex h-screen relative",children:[e.jsx("div",{className:`fixed md:static top-0 left-0 h-full bg-gray-900 z-50 transition-transform duration-300 ease-in-out
          ${t?"translate-x-0 w-3/5":"-translate-x-full"} md:translate-x-0 md:w-1/4`,children:e.jsx(Oe,{onSelectConversation:i})}),e.jsx("div",{className:"flex-1 md:w-3/4 w-full h-full overflow-hidden",children:e.jsx(Te,{})})]})};export{We as default};
