import{j as t}from"./mui-DM0ppf3M.js";import{r as v}from"./calendar-BpW-aEGs.js";import{a2 as re,a3 as ne,s as F,u as le,a4 as ie,a as ce,G as de,j as ue,a5 as pe,l as me,a6 as ge,c as he,k as xe,E as fe,I as q,T as be,X as we,B as C,x as ye}from"./index-BXNurRLk.js";import{k as je}from"./icons-A8qOaPVA.js";import"./reactPlayer-CjHFj7G4.js";import"./lottie-DTlWc_fK.js";import"./gsap-Brfk6Bdo.js";import"./filepond-DcLflJls.js";const $e=()=>{const a=re();return ne({mutationFn:async({file:g,userId:c,postId:o,filename:i})=>{const e=`${c}/${o}/${i}`,{data:h,error:x}=await F.storage.from("post-media").upload(e,g,{cacheControl:"3600",upsert:!0});if(x)throw new Error(x.message);const{data:m}=F.storage.from("post-media").getPublicUrl(e);return m!=null&&m.publicUrl?m.publicUrl:(console.warn("getPublicUrl did not return a valid publicUrl",m),null)},onMutate:async({file:g,userId:c,postId:o,filename:i})=>{await a.cancelQueries({queryKey:["posts"]});const e=a.getQueryData(["posts"]),h={id:`temp-${Date.now()}`,url:URL.createObjectURL(g),created_at:new Date().toISOString(),userId:c,postId:o,filename:i};return a.setQueryData(["posts"],(x=[])=>[...x,h]),{previousDetails:e}},onError:(g,c,o)=>{o!=null&&o.previousDetails&&a.setQueryData(["posts"],o.previousDetails)},onSettled:(g,c)=>{a.invalidateQueries({queryKey:["posts"]})}})},Ce=()=>{var O;const{t:a}=le("posts"),c=ie().state,o=(c==null?void 0:c.groupId)??null,{user:i}=ce(),{postId:e}=de(),h=ue(),{createPost:x,updatePost:m,fetchPost:A,deletePost:B}=pe(),S=$e(),{upsertHashtag:M}=me(),{getHashtagsByPostId:T,upsertPostHashtag:V,deletePostHashtags:K}=ge(),[b,y]=v.useState([]),[d,j]=v.useState([]),[z,I]=v.useState(!1),{register:P,handleSubmit:G,setValue:$,watch:U,reset:X,formState:{errors:k,isSubmitting:E}}=he(),f=(O=U("newHashtag"))==null?void 0:O.trim(),{data:u,isLoading:J,error:R}=e?A(e):{data:null,isLoading:!1,error:null},{data:N}=e?T(e):{data:[]};v.useEffect(()=>{if(e&&u&&($("title",u.title),$("content",u.content),y(u.images_urls||[]),N)){const s=N.map(n=>{var p;return((p=n==null?void 0:n.hashtags)==null?void 0:p.name)||""});j(s)}},[u,N,e,$]);const W=()=>{f&&!d.includes(f)&&d.length<5&&(j([...d,f]),$("newHashtag",""))},Y=s=>{j(d.filter(n=>n!==s))},Z=s=>{y(s)},ee=async s=>{const n=s.split("/").pop();if(!n)return;await F.storage.from("post-media").remove([n]);const p=b.filter(D=>D!==s);y(p)},te=()=>I(!0),ae=async()=>{!e||!u||(await B(e),h(o?`/group/${o}`:`/profile/${u.profile_id}`),I(!1))},se=async s=>{const{newHashtag:n,...p}=s,D=d.map(l=>l.trim()).filter(Boolean);try{let l;if(e&&u){const H=(await Promise.all(b.map(async(r,_)=>{if(!(r instanceof File))return r;const L=`${Date.now()}-${_}-${r.name}`;return await S.mutateAsync({file:r,userId:o||(i==null?void 0:i.id),postId:e,filename:L})}))).filter(r=>r!=null);await m({id:e,updatedPost:{...p,images_urls:H}}),await K({post_id:e}),l=u}else{if(!i)throw new Error("User not logged in");l=await x({...p,images_urls:[],...o?{group_id:o}:{profile_id:i.id}});const H=(await Promise.all(b.map(async(r,_)=>{if(!(r instanceof File))return r;const L=`${Date.now()}-${_}-${r.name}`;return await S.mutateAsync({file:r,userId:o||i.id,postId:l.id,filename:L})}))).filter(r=>r!=null);await m({id:l.id,updatedPost:{images_urls:H}})}const oe=await Promise.all(D.map(w=>M({name:w})));await Promise.all(oe.map(w=>V({post_id:l.id,hashtag_id:w.id}))),X(),y([]),j([]),h(e?o?`/group/${o}`:`/profile/${l.profile_id}`:"/explore")}catch(l){console.error("Post error:",(l==null?void 0:l.message)||l)}};if(J)return t.jsx(xe,{});if(R)return t.jsx(fe,{error:R.message});const Q=/^#[\w-]+$/.test(f||"");return t.jsxs(t.Fragment,{children:[t.jsx("h2",{className:"text-2xl text-yellow-600 font-semibold text-center mb-4",children:a(e?"update.title":"create.title")}),t.jsxs("form",{onSubmit:G(se),className:"space-y-6 bg-gradient-to-r from-gray-900 p-6 rounded-lg shadow-md max-w-xl mx-auto",children:[t.jsx(q,{id:"title",label:a(`${e?"update":"create"}.labels.title`),placeholder:a(`${e?"update":"create"}.placeholders.title`),maxLength:30,register:P,validation:{required:a(`${e?"update":"create"}.errors.title`)},error:k.title,classForLabel:"text-gray-400 text-center md:text-left"}),t.jsx(be,{id:"content",label:a(`${e?"update":"create"}.labels.content`),placeholder:a(`${e?"update":"create"}.placeholders.content`),register:P,validation:{maxLength:{value:150,message:a(`${e?"update":"create"}.errors.content`)}},error:k.content,maxLength:150,watchValue:U("content"),classForLabel:"text-gray-400"}),t.jsxs("div",{className:"flex flex-col gap-2",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(q,{id:"newHashtag",label:a(`${e?"update":"create"}.labels.hashtags`),placeholder:a(`${e?"update":"create"}.placeholders.hashtags`),type:"text",register:P,maxLength:12,classForLabel:"!text-gray-400",className:"!flex-1"}),t.jsx("button",{type:"button",onClick:W,disabled:!f||d.length>=5||!Q,className:`mt-4 p-2 rounded-full ${!f||d.length>=5||!Q?"cursor-not-allowed text-emerald-900":"cursor-pointer text-emerald-500 hover:text-emerald-700"}`,children:t.jsx(je,{size:22})})]}),d.length>0&&t.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:d.map((s,n)=>t.jsxs("span",{className:"px-2 py-1 text-sm rounded bg-sky-800 text-white flex items-center gap-2",children:[s,t.jsx("button",{type:"button",onClick:()=>Y(s),className:"text-red-400 hover:text-red-600 font-bold",children:"×"})]},n))})]}),e&&b.some(s=>typeof s=="string")&&t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-2",children:a("update.labels.existingImages")}),t.jsx("div",{className:"flex flex-wrap gap-4",children:b.filter(s=>typeof s=="string").map((s,n)=>t.jsxs("div",{className:"relative",children:[t.jsx("img",{src:s,alt:`Existing post image ${n}`,className:"w-32 h-32 object-cover rounded-lg"}),t.jsx("button",{type:"button",onClick:p=>{p.stopPropagation(),ee(s)},className:"absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center",children:"×"})]},n))})]}),t.jsx(we,{amount:3,onFilesUpdate:Z,classForLabel:"text-gray-400 text-center md:text-left"}),t.jsxs("div",{className:"flex justify-center gap-4",children:[t.jsx(C,{type:"button",onClick:()=>h("/explore"),className:"!bg-gray-600 hover:!bg-gray-700",children:a(`${e?"update":"create"}.buttons.cancel`)}),t.jsx(C,{type:"submit",disabled:E,children:a(E?`${e?"update":"create"}.buttons.${e?"updating":"posting"}`:`${e?"update":"create"}.buttons.${e?"update":"post"}`)}),e&&t.jsx(C,{type:"button",onClick:te,className:"!bg-red-600 hover:!bg-red-700",children:a("update.buttons.delete")})]})]}),e&&t.jsx(ye,{isOpen:z,title:a("update.buttons.delete"),message:a("update.errors.confirmDelete"),onConfirm:ae,onCancel:()=>I(!1),confirmLabel:a("update.buttons.delete"),cancelLabel:a("update.buttons.cancel"),color:"error"})]})};export{Ce as default};
