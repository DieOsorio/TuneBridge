import{j as t}from"./mui-DntPDMdt.js";import{r as I}from"./calendar-DXWKnWXk.js";import{ac as oe,ad as ne,s as q,u as le,ae as ie,a as ce,M as de,j as ue,af as pe,l as me,ag as ge,c as he,k as xe,E as fe,I as Q,U as be,ah as we,a0 as ye,B as F,x as je,a3 as $e}from"./index-DUDycYqK.js";import"./reactPlayer-CBmCIXQE.js";import"./icons-Cf_ygVw3.js";import"./lottie-FCmafNqs.js";import"./gsap-CH_iu5NA.js";import"./filepond-DvarZm2e.js";const ve=()=>{const a=oe();return ne({mutationFn:async({file:g,userId:c,postId:r,filename:i})=>{const e=`${c}/${r}/${i}`,{data:h,error:x}=await q.storage.from("post-media").upload(e,g,{cacheControl:"3600",upsert:!0});if(x)throw new Error(x.message);const{data:m}=q.storage.from("post-media").getPublicUrl(e);return m!=null&&m.publicUrl?m.publicUrl:(console.warn("getPublicUrl did not return a valid publicUrl",m),null)},onMutate:async({file:g,userId:c,postId:r,filename:i})=>{await a.cancelQueries({queryKey:["posts"]});const e=a.getQueryData(["posts"]),h={id:`temp-${Date.now()}`,url:URL.createObjectURL(g),created_at:new Date().toISOString(),userId:c,postId:r,filename:i};return a.setQueryData(["posts"],(x=[])=>[...x,h]),{previousDetails:e}},onError:(g,c,r)=>{r!=null&&r.previousDetails&&a.setQueryData(["posts"],r.previousDetails)},onSettled:(g,c)=>{a.invalidateQueries({queryKey:["posts"]})}})},Ce=()=>{var E;const{t:a}=le("posts"),c=ie().state,r=(c==null?void 0:c.groupId)??null,{user:i}=ce(),{postId:e}=de(),h=ue(),{createPost:x,updatePost:m,fetchPost:B,deletePost:M}=pe(),C=ve(),{upsertHashtag:O}=me(),{getHashtagsByPostId:V,upsertPostHashtag:A,deletePostHashtags:K}=ge(),[b,y]=I.useState([]),[d,j]=I.useState([]),[T,P]=I.useState(!1),{register:N,handleSubmit:z,setValue:$,watch:v,reset:G,formState:{errors:S,isSubmitting:U}}=he(),f=(E=v("newHashtag"))==null?void 0:E.trim(),{data:u,isLoading:J,error:R}=e?B(e):{data:null,isLoading:!1,error:null},{data:H}=e?V(e):{data:[]};I.useEffect(()=>{if(e&&u&&($("title",u.title),$("content",u.content),y(u.images_urls||[]),H)){const s=H.map(n=>{var p;return((p=n==null?void 0:n.hashtags)==null?void 0:p.name)||""});j(s)}},[u,H,e,$]);const W=()=>{f&&!d.includes(f)&&d.length<5&&(j([...d,f]),$("newHashtag",""))},X=s=>{j(d.filter(n=>n!==s))},Y=s=>{y(s)},Z=async s=>{$e("post-media",s);const n=b.filter(p=>p!==s);y(n)},ee=()=>P(!0),te=async()=>{!e||!u||(await M(e),h(r?`/group/${r}`:`/profile/${u.profile_id}`),P(!1))},ae=async s=>{const{newHashtag:n,...p}=s,se=d.map(l=>l.trim()).filter(Boolean);try{let l;if(e&&u){const D=(await Promise.all(b.map(async(o,_)=>{if(!(o instanceof File))return o;const L=`${Date.now()}-${_}-${o.name}`;return await C.mutateAsync({file:o,userId:r||(i==null?void 0:i.id),postId:e,filename:L})}))).filter(o=>o!=null);await m({id:e,updatedPost:{...p,images_urls:D}}),await K({post_id:e}),l=u}else{if(!i)throw new Error("User not logged in");l=await x({...p,images_urls:[],...r?{group_id:r}:{profile_id:i.id}});const D=(await Promise.all(b.map(async(o,_)=>{if(!(o instanceof File))return o;const L=`${Date.now()}-${_}-${o.name}`;return await C.mutateAsync({file:o,userId:r||i.id,postId:l.id,filename:L})}))).filter(o=>o!=null);await m({id:l.id,updatedPost:{images_urls:D}})}const re=await Promise.all(se.map(w=>O({name:w})));await Promise.all(re.map(w=>A({post_id:l.id,hashtag_id:w.id}))),G(),y([]),j([]),h(e?r?`/group/${r}`:`/profile/${l.profile_id}`:"/explore")}catch(l){console.error("Post error:",(l==null?void 0:l.message)||l)}};if(J)return t.jsx(xe,{});if(R)return t.jsx(fe,{error:R.message});const k=/^#[\w-]+$/.test(f||"");return t.jsxs(t.Fragment,{children:[t.jsx("h2",{className:"text-2xl text-yellow-600 font-semibold text-center mb-4",children:a(e?"update.title":"create.title")}),t.jsxs("form",{onSubmit:z(ae),className:"space-y-6 bg-gradient-to-r from-gray-900 p-6 rounded-lg shadow-md max-w-xl mx-auto",children:[t.jsx(Q,{id:"title",label:a(`${e?"update":"create"}.labels.title`),placeholder:a(`${e?"update":"create"}.placeholders.title`),maxLength:30,watchValue:v("title"),register:N,validation:{required:a(`${e?"update":"create"}.errors.title`)},error:S.title,classForLabel:"text-gray-400 text-center md:text-left"}),t.jsx(be,{id:"content",label:a(`${e?"update":"create"}.labels.content`),placeholder:a(`${e?"update":"create"}.placeholders.content`),register:N,validation:{required:a(`${e?"update":"create"}.errors.contentRequired`),maxLength:{value:150,message:a(`${e?"update":"create"}.errors.content`)}},error:S.content,maxLength:150,watchValue:v("content"),classForLabel:"text-gray-400"}),t.jsxs("div",{className:"flex flex-col gap-2",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(Q,{id:"newHashtag",label:a(`${e?"update":"create"}.labels.hashtags`),placeholder:a(`${e?"update":"create"}.placeholders.hashtags`),type:"text",register:N,maxLength:12,watchValue:v("newHashtag"),classForLabel:"!text-gray-400",className:"!flex-1"}),t.jsx("button",{type:"button",onClick:W,disabled:!f||d.length>=5||!k,className:`mt-4 p-2 rounded-full ${!f||d.length>=5||!k?"cursor-not-allowed text-emerald-900":"cursor-pointer text-emerald-500 hover:text-emerald-700"}`,children:t.jsx(we,{className:"w-6 h-6"})})]}),d.length>0&&t.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:d.map((s,n)=>t.jsxs("span",{className:"px-2 py-1 text-sm rounded bg-sky-800 text-white flex items-center gap-2",children:[s,t.jsx("button",{type:"button",onClick:()=>X(s),className:"text-red-400 hover:text-red-600 font-bold",children:"×"})]},n))})]}),e&&b.some(s=>typeof s=="string")&&t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-2",children:a("update.labels.existingImages")}),t.jsx("div",{className:"flex flex-wrap gap-4",children:b.filter(s=>typeof s=="string").map((s,n)=>t.jsxs("div",{className:"relative",children:[t.jsx("img",{src:s,alt:`Existing post image ${n}`,className:"w-32 h-32 object-cover rounded-lg"}),t.jsx("button",{type:"button",onClick:p=>{p.stopPropagation(),Z(s)},className:"absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center",children:"×"})]},n))})]}),t.jsx(ye,{amount:3,onFilesUpdate:Y,classForLabel:"text-gray-400 text-center md:text-left"}),t.jsxs("div",{className:"flex justify-center gap-4",children:[t.jsx(F,{type:"button",onClick:()=>h("/explore"),className:"!bg-gray-600 hover:!bg-gray-700",children:a(`${e?"update":"create"}.buttons.cancel`)}),t.jsx(F,{type:"submit",disabled:U,children:a(U?`${e?"update":"create"}.buttons.${e?"updating":"posting"}`:`${e?"update":"create"}.buttons.${e?"update":"post"}`)}),e&&t.jsx(F,{type:"button",onClick:ee,className:"!bg-red-600 hover:!bg-red-700",children:a("update.buttons.delete")})]})]}),e&&t.jsx(je,{isOpen:T,title:a("update.buttons.delete"),message:a("update.errors.confirmDelete"),onConfirm:te,onCancel:()=>P(!1),confirmLabel:a("update.buttons.delete"),cancelLabel:a("update.buttons.cancel"),color:"error"})]})};export{Ce as default};
