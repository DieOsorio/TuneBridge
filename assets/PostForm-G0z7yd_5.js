import{j as t}from"./mui-DM0ppf3M.js";import{r as I}from"./calendar-BpW-aEGs.js";import{a2 as oe,a3 as ne,s as F,u as le,a4 as ie,a as de,G as ce,j as ue,a5 as pe,l as me,a6 as ge,c as he,k as fe,E as xe,I as q,T as be,X as we,B as C,x as ye}from"./index-DR1Vxlj-.js";import{k as je}from"./icons-A8qOaPVA.js";import"./reactPlayer-CjHFj7G4.js";import"./lottie-DTlWc_fK.js";import"./gsap-Brfk6Bdo.js";import"./filepond-DcLflJls.js";const $e=()=>{const a=oe();return ne({mutationFn:async({file:m,userId:c,postId:r,filename:d})=>{const e=`${c}/${r}/${d}`,{data:g,error:h}=await F.storage.from("post-media").upload(e,m,{cacheControl:"3600",upsert:!0});if(h)throw new Error(h.message);const{data:u}=F.storage.from("post-media").getPublicUrl(e);return u!=null&&u.publicUrl?u.publicUrl:(console.warn("getPublicUrl did not return a valid publicUrl",u),null)},onMutate:async({file:m,userId:c,postId:r,filename:d})=>{await a.cancelQueries({queryKey:["posts"]});const e=a.getQueryData(["posts"]),g={id:`temp-${Date.now()}`,url:URL.createObjectURL(m),created_at:new Date().toISOString(),userId:c,postId:r,filename:d};return a.setQueryData(["posts"],(h=[])=>[...h,g]),{previousDetails:e}},onError:(m,c,r)=>{r!=null&&r.previousDetails&&a.setQueryData(["posts"],r.previousDetails)},onSettled:(m,c)=>{a.invalidateQueries({queryKey:["posts"]})}})},Ce=()=>{var O;const{t:a}=le("posts"),c=ie().state,r=(c==null?void 0:c.groupId)??null,{user:d}=de(),{postId:e}=ce(),g=ue(),{createPost:h,updatePost:u,fetchPost:A,deletePost:B}=pe(),S=$e(),{upsertHashtag:M}=me(),{getHashtagsByPostId:T,upsertPostHashtag:V,deletePostHashtags:K}=ge(),[x,j]=I.useState([]),[p,$]=I.useState([]),[z,P]=I.useState(!1),{register:N,handleSubmit:G,setValue:v,watch:U,reset:X,formState:{errors:k,isSubmitting:E}}=he(),f=(O=U("newHashtag"))==null?void 0:O.trim(),{data:i,isLoading:J,error:R}=e?A(e):{data:null,isLoading:!1,error:null},{data:_}=e?T(e):{data:[]};I.useEffect(()=>{if(e&&i&&(v("title",i.title),v("content",i.content),j(i.images_urls||[]),_)){const s=_.map(n=>n.hashtags.name);$(s)}},[i,_,e,v]);const W=()=>{f&&!p.includes(f)&&p.length<5&&($([...p,f]),v("newHashtag",""))},Y=s=>{$(p.filter(n=>n!==s))},Z=s=>{j(n=>[...n,...s])},ee=async s=>{const n=s.split("/").pop();if(!n)return;await F.storage.from("post-media").remove([n]);const b=x.filter(w=>w!==s);i&&(await u({id:i.id,updatedPost:{...i,images_urls:b.filter(w=>typeof w=="string")}}),j(b))},te=()=>P(!0),ae=async()=>{!e||!i||(await B(e),g(r?`/group/${r}`:`/profile/${i.profile_id}`),P(!1))},se=async s=>{const{newHashtag:n,...b}=s,w=p.map(l=>l.trim()).filter(Boolean);try{let l;if(e&&i){const D=(await Promise.all(x.map(async(o,H)=>{if(!(o instanceof File))return o;const L=`${Date.now()}-${H}-${o.name}`;return await S.mutateAsync({file:o,userId:r||(d==null?void 0:d.id),postId:e,filename:L})}))).filter(o=>o!=null);await u({id:e,updatedPost:{...b,images_urls:D}}),await K({post_id:e}),l=i}else{if(!d)throw new Error("User not logged in");l=await h({...b,images_urls:[],...r?{group_id:r}:{profile_id:d.id}});const D=(await Promise.all(x.map(async(o,H)=>{if(!(o instanceof File))return o;const L=`${Date.now()}-${H}-${o.name}`;return await S.mutateAsync({file:o,userId:r||d.id,postId:l.id,filename:L})}))).filter(o=>o!=null);await u({id:l.id,updatedPost:{images_urls:D}})}const re=await Promise.all(w.map(y=>M({name:y})));await Promise.all(re.map(y=>V({post_id:l.id,hashtag_id:y.id}))),X(),j([]),$([]),g(e?r?`/group/${r}`:`/profile/${l.profile_id}`:"/explore")}catch(l){console.error("Post error:",(l==null?void 0:l.message)||l)}};if(J)return t.jsx(fe,{});if(R)return t.jsx(xe,{error:R.message});const Q=/^#[\w-]+$/.test(f||"");return t.jsxs(t.Fragment,{children:[t.jsx("h2",{className:"text-2xl text-yellow-600 font-semibold text-center mb-4",children:a(e?"update.title":"create.title")}),t.jsxs("form",{onSubmit:G(se),className:"space-y-6 bg-gradient-to-r from-gray-900 p-6 rounded-lg shadow-md max-w-xl mx-auto",children:[t.jsx(q,{id:"title",label:a(`${e?"update":"create"}.labels.title`),placeholder:a(`${e?"update":"create"}.placeholders.title`),maxLength:30,register:N,validation:{required:a(`${e?"update":"create"}.errors.title`)},error:k.title,classForLabel:"text-gray-400 text-center md:text-left"}),t.jsx(be,{id:"content",label:a(`${e?"update":"create"}.labels.content`),placeholder:a(`${e?"update":"create"}.placeholders.content`),register:N,validation:{maxLength:{value:150,message:a(`${e?"update":"create"}.errors.content`)}},error:k.content,maxLength:150,watchValue:U("content"),classForLabel:"text-gray-400"}),t.jsxs("div",{className:"flex flex-col gap-2",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(q,{id:"newHashtag",label:a(`${e?"update":"create"}.labels.hashtags`),placeholder:a(`${e?"update":"create"}.placeholders.hashtags`),type:"text",register:N,maxLength:12,classForLabel:"!text-gray-400",className:"!flex-1"}),t.jsx("button",{type:"button",onClick:W,disabled:!f||p.length>=5||!Q,className:`mt-4 p-2 rounded-full ${!f||p.length>=5||!Q?"cursor-not-allowed text-emerald-900":"cursor-pointer text-emerald-500 hover:text-emerald-700"}`,children:t.jsx(je,{size:22})})]}),p.length>0&&t.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:p.map((s,n)=>t.jsxs("span",{className:"px-2 py-1 text-sm rounded bg-sky-800 text-white flex items-center gap-2",children:[s,t.jsx("button",{type:"button",onClick:()=>Y(s),className:"text-red-400 hover:text-red-600 font-bold",children:"×"})]},n))})]}),e&&x.some(s=>typeof s=="string")&&t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-2",children:a("update.labels.existingImages")}),t.jsx("div",{className:"flex flex-wrap gap-4",children:x.filter(s=>typeof s=="string").map((s,n)=>t.jsxs("div",{className:"relative",children:[t.jsx("img",{src:s,alt:`Existing post image ${n}`,className:"w-32 h-32 object-cover rounded-lg"}),t.jsx("button",{onClick:()=>ee(s),className:"absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center",children:"×"})]},n))})]}),t.jsx(we,{amount:3,onFilesUpdate:Z,classForLabel:"text-gray-400 text-center md:text-left"}),t.jsxs("div",{className:"flex justify-center gap-4",children:[t.jsx(C,{type:"button",onClick:()=>g("/explore"),className:"!bg-gray-600 hover:!bg-gray-700",children:a(`${e?"update":"create"}.buttons.cancel`)}),t.jsx(C,{type:"submit",disabled:E,children:a(E?`${e?"update":"create"}.buttons.${e?"updating":"posting"}`:`${e?"update":"create"}.buttons.${e?"update":"post"}`)}),e&&t.jsx(C,{type:"button",onClick:te,className:"!bg-red-600 hover:!bg-red-700",children:a("update.buttons.delete")})]})]}),e&&t.jsx(ye,{isOpen:z,title:a("update.buttons.delete"),message:a("update.errors.confirmDelete"),onConfirm:ae,onCancel:()=>P(!1),confirmLabel:a("update.buttons.delete"),cancelLabel:a("update.buttons.cancel"),color:"error"})]})};export{Ce as default};
