import{j as t}from"./mui-O-_7DbpJ.js";import{r as v}from"./calendar-BpW-aEGs.js";import{a3 as se,a4 as re,s as F,u as oe,a5 as le,a as ne,A as ie,h as de,a6 as ce,j as ue,a7 as pe,c as me,i as ge,E as he,I as R,T as xe,X as fe,B as C,t as be}from"./index-Cf-eeQSk.js";import{i as we}from"./icons-D__VgVoR.js";import"./reactPlayer-D7fnNHFf.js";import"./lottie-DTlWc_fK.js";import"./gsap-Brfk6Bdo.js";import"./filepond-DcLflJls.js";const ye=()=>{const a=se();return re({mutationFn:async({file:d,userId:r,postId:l,filename:e})=>{const u=`${r}/${l}/${e}`,{data:w,error:p}=await F.storage.from("post-media").upload(u,d,{cacheControl:"3600",upsert:!0});if(p)throw new Error(p.message);const{data:m,error:y}=F.storage.from("post-media").getPublicUrl(u);if(y)throw new Error(`Get public URL failed: ${y.message}`);return m!=null&&m.publicUrl?m.publicUrl:(console.warn("getPublicUrl did not return a valid publicUrl",m),null)},onMutate:async({file:d,userId:r,postId:l,filename:e})=>{await a.cancelQueries({queryKey:["posts"]});const u=a.getQueryData(["posts"]),w={id:`temp-${Date.now()}`,url:URL.createObjectURL(d),created_at:new Date().toISOString(),userId:r,postId:l,filename:e};return a.setQueryData(["posts"],(p=[])=>[...p,w]),{previousDetails:u}},onError:(d,r,l)=>{l!=null&&l.previousDetails&&a.setQueryData(["posts"],l.previousDetails)},onSettled:(d,r)=>{a.invalidateQueries({queryKey:["posts"]})}})},Le=()=>{var O;const{t:a}=oe("posts"),{state:d}=le(),r=(d==null?void 0:d.groupId)||null,{user:l}=ne(),{postId:e}=ie(),u=de(),{createPost:w,updatePost:p,fetchPost:m,deletePost:y}=ce(),S=ye(),{upsertHashtag:q}=ue(),{getHashtagsByPostId:B,upsertPostHashtag:M,deletePostHashtags:T}=pe(),[f,j]=v.useState([]),[c,$]=v.useState([]),[V,P]=v.useState(!1),{register:I,handleSubmit:K,setValue:N,watch:U,reset:z,formState:{errors:E,isSubmitting:k}}=me(),x=(O=U("newHashtag"))==null?void 0:O.trim(),{data:n,isLoading:G,error:Q}=e?m(e):{data:null,isLoading:!1,error:null},{data:H}=e?B(e):{data:[]};v.useEffect(()=>{if(e&&n&&(N("title",n.title),N("content",n.content),j(n.images_urls||[]),H)){const s=H.map(o=>o.hashtags.name);$(s)}},[n,H,e]);const X=()=>{x&&!c.includes(x)&&c.length<5&&($([...c,x]),N("newHashtag",""))},J=s=>{$(c.filter(o=>o!==s))},W=s=>{j(o=>[...o,...s])},Y=async s=>{const o=s.split("/").pop();await F.storage.from("post-media").remove([o]);const b=f.filter(D=>D!==s);await p({id:n.id,updatedPost:{...n,images_urls:b}}),j(b)},Z=()=>P(!0),ee=async()=>{await y(e),u(r?`/group/${gorupId}`:`/profile/${n.profile_id}`),P(!1)};console.log("groupId from state:",r);const te=async s=>{const{newHashtag:o,...b}=s,D=c.map(i=>i.trim()).filter(Boolean);try{let i;if(e){const g=await Promise.all(f.map(async(h,L)=>{if(typeof h=="string")return h;const _=`${Date.now()}-${L}-${h.name}`;return await S.mutateAsync({file:h,userId:n.profile_id,postId:e,filename:_})}));await p({id:e,updatedPost:{...b,images_urls:g}}),await T({post_id:e}),i=n}else{i=await w({...b,images_urls:[],...r?{group_id:r}:{profile_id:l.id}});const g=await Promise.all(f.map(async(h,L)=>{const _=`${Date.now()}-${L}-${h.name}`;return await S.mutateAsync({file:h,userId:r||l.id,postId:i.id,filename:_})}));await p({id:i.id,updatedPost:{images_urls:g}})}const ae=await Promise.all(D.map(g=>q({name:g})));await Promise.all(ae.map(g=>M({post_id:i.id,hashtag_id:g.id}))),z(),j([]),$([]),u(e?r?`/group/${r}`:`/profile/${i.profile_id}`:"/explore")}catch(i){console.error("Post error:",i.message)}};if(G)return t.jsx(ge,{});if(Q)return t.jsx(he,{error:Q.message});const A=/^#[\w-]+$/.test(x||"");return t.jsxs(t.Fragment,{children:[t.jsx("h2",{className:"text-2xl text-yellow-600 font-semibold text-center mb-4",children:a(e?"update.title":"create.title")}),t.jsxs("form",{onSubmit:K(te),className:"space-y-6 bg-gradient-to-r from-gray-900 p-6 rounded-lg shadow-md max-w-xl mx-auto",children:[t.jsx(R,{id:"title",label:a(`${e?"update":"create"}.labels.title`),placeholder:a(`${e?"update":"create"}.placeholders.title`),maxLength:30,register:I,validation:{required:a(`${e?"update":"create"}.errors.title`)},error:E.title,classForLabel:"text-gray-400 text-center md:text-left"}),t.jsx(xe,{id:"content",label:a(`${e?"update":"create"}.labels.content`),placeholder:a(`${e?"update":"create"}.placeholders.content`),register:I,validation:{maxLength:{value:150,message:a(`${e?"update":"create"}.errors.content`)}},error:E.content,maxLength:150,watchValue:U("content"),classForLabel:"text-gray-400"}),t.jsxs("div",{className:"flex flex-col gap-2",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(R,{id:"newHashtag",label:a(`${e?"update":"create"}.labels.hashtags`),placeholder:a(`${e?"update":"create"}.placeholders.hashtags`),type:"text",register:I,maxLength:12,classForLabel:"!text-gray-400",className:"!flex-1"}),t.jsx("button",{type:"button",onClick:X,disabled:!x||c.length>=5||!A,className:`
                mt-4 p-2 rounded-full
                ${!x||c.length>=5||!A?"cursor-not-allowed text-emerald-900":"cursor-pointer text-emerald-500 hover:text-emerald-700"}
              `,children:t.jsx(we,{size:22})})]}),c.length>0&&t.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:c.map((s,o)=>t.jsxs("span",{className:"px-2 py-1 text-sm rounded bg-sky-800 text-white flex items-center gap-2",children:[s,t.jsx("button",{type:"button",onClick:()=>J(s),className:"text-red-400 hover:text-red-600 font-bold",children:"×"})]},o))})]}),e&&f.some(s=>typeof s=="string")&&t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-2",children:a("update.labels.existingImages")}),t.jsx("div",{className:"flex flex-wrap gap-4",children:f.filter(s=>typeof s=="string").map((s,o)=>t.jsxs("div",{className:"relative",children:[t.jsx("img",{src:s,className:"w-32 h-32 object-cover rounded-lg"}),t.jsx("button",{onClick:()=>Y(s),className:"absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center",children:"×"})]},o))})]}),t.jsx(fe,{amount:3,onFilesUpdate:W,classForLabel:"text-gray-400 text-center md:text-left"}),t.jsxs("div",{className:"flex justify-center gap-4",children:[t.jsx(C,{type:"button",onClick:()=>u("/explore"),className:"!bg-gray-600 hover:!bg-gray-700",children:a(`${e?"update":"create"}.buttons.cancel`)}),t.jsx(C,{type:"submit",disabled:k,children:a(k?`${e?"update":"create"}.buttons.${e?"updating":"posting"}`:`${e?"update":"create"}.buttons.${e?"update":"post"}`)}),e&&t.jsx(C,{type:"button",onClick:Z,className:"!bg-red-600 hover:!bg-red-700",children:a("update.buttons.delete")})]})]}),e&&t.jsx(be,{isOpen:V,title:a("update.buttons.delete"),message:a("update.errors.confirmDelete"),onConfirm:ee,onCancel:()=>P(!1),confirmLabel:a("update.buttons.delete"),cancelLabel:a("update.buttons.cancel"),color:"error"})]})};export{Le as default};
