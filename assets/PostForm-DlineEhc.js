import{j as t}from"./mui-r_OKU3k3.js";import{r as v}from"./filepond-C4Y8_Bzv.js";import{$ as te,a0 as ae,s as F,u as se,a as re,A as oe,h as le,a1 as ne,j as ie,a2 as ce,c as de,i as ue,E as me,I as O,T as pe,U as ge,B as C,t as he}from"./index-Lh6-Uiv0.js";import{i as xe}from"./icons-C9PPhvnE.js";import"./reactPlayer-P4y7tfwb.js";import"./lottie-Qij33HW6.js";import"./gsap-Brfk6Bdo.js";const fe=()=>{const a=te();return ae({mutationFn:async({file:c,userId:e,postId:r,filename:x})=>{const d=`${e}/${r}/${x}`,{data:w,error:g}=await F.storage.from("post-media").upload(d,c,{cacheControl:"3600",upsert:!0});if(g)throw new Error(g.message);const{data:u,error:y}=F.storage.from("post-media").getPublicUrl(d);if(y)throw new Error(`Get public URL failed: ${y.message}`);return u!=null&&u.publicUrl?u.publicUrl:(console.warn("getPublicUrl did not return a valid publicUrl",u),null)},onMutate:async({file:c,userId:e,postId:r,filename:x})=>{await a.cancelQueries({queryKey:["posts"]});const d=a.getQueryData(["posts"]),w={id:`temp-${Date.now()}`,url:URL.createObjectURL(c),created_at:new Date().toISOString(),userId:e,postId:r,filename:x};return a.setQueryData(["posts"],(g=[])=>[...g,w]),{previousDetails:d}},onError:(c,e,r)=>{r!=null&&r.previousDetails&&a.setQueryData(["posts"],r.previousDetails)},onSettled:(c,e)=>{a.invalidateQueries({queryKey:["posts"]})}})},Ie=()=>{var A;const{t:a}=se("posts"),{user:c}=re(),{postId:e}=oe(),r=le(),{createPost:x,updatePost:d,fetchPost:w,deletePost:g}=ne(),u=fe(),{upsertHashtag:y}=ie(),{getHashtagsByPostId:R,upsertPostHashtag:q,deletePostHashtags:B}=ce(),[f,j]=v.useState([]),[i,$]=v.useState([]),[M,P]=v.useState(!1),{register:I,handleSubmit:T,setValue:N,watch:S,reset:V,formState:{errors:U,isSubmitting:E}}=de(),h=(A=S("newHashtag"))==null?void 0:A.trim(),{data:l,isLoading:K,error:k}=e?w(e):{data:null,isLoading:!1,error:null},{data:H}=e?R(e):{data:[]};v.useEffect(()=>{if(e&&l&&(N("title",l.title),N("content",l.content),j(l.images_urls||[]),H)){const s=H.map(o=>o.hashtags.name);$(s)}},[l,H,e]);const z=()=>{h&&!i.includes(h)&&i.length<5&&($([...i,h]),N("newHashtag",""))},G=s=>{$(i.filter(o=>o!==s))},J=s=>{j(o=>[...o,...s])},W=async s=>{const o=s.split("/").pop();await F.storage.from("post-media").remove([o]);const b=f.filter(D=>D!==s);await d({id:l.id,updatedPost:{...l,images_urls:b}}),j(b)},X=()=>P(!0),Y=async()=>{await g(e),r(`/profile/${l.profile_id}`),P(!1)},Z=async s=>{const{newHashtag:o,...b}=s,D=i.map(n=>n.trim()).filter(Boolean);try{let n;if(e){const m=await Promise.all(f.map(async(p,L)=>{if(typeof p=="string")return p;const _=`${Date.now()}-${L}-${p.name}`;return await u.mutateAsync({file:p,userId:l.profile_id,postId:e,filename:_})}));await d({id:e,updatedPost:{...b,images_urls:m}}),await B({post_id:e}),n=l}else{n=await x({...b,profile_id:c.id,images_urls:[]});const m=await Promise.all(f.map(async(p,L)=>{const _=`${Date.now()}-${L}-${p.name}`;return await u.mutateAsync({file:p,userId:c.id,postId:n.id,filename:_})}));await d({id:n.id,updatedPost:{images_urls:m}})}const ee=await Promise.all(D.map(m=>y({name:m})));await Promise.all(ee.map(m=>q({post_id:n.id,hashtag_id:m.id}))),V(),j([]),$([]),r(e?`/profile/${n.profile_id}`:"/explore")}catch(n){console.error("Post error:",n.message)}};if(K)return t.jsx(ue,{});if(k)return t.jsx(me,{error:k.message});const Q=/^#[\w-]+$/.test(h||"");return t.jsxs(t.Fragment,{children:[t.jsx("h2",{className:"text-2xl text-yellow-600 font-semibold text-center mb-4",children:a(e?"update.title":"create.title")}),t.jsxs("form",{onSubmit:T(Z),className:"space-y-6 bg-gradient-to-r from-gray-900 p-6 rounded-lg shadow-md max-w-xl mx-auto",children:[t.jsx(O,{id:"title",label:a(`${e?"update":"create"}.labels.title`),placeholder:a(`${e?"update":"create"}.placeholders.title`),maxLength:30,register:I,validation:{required:a(`${e?"update":"create"}.errors.title`)},error:U.title,classForLabel:"text-gray-400 text-center md:text-left"}),t.jsx(pe,{id:"content",label:a(`${e?"update":"create"}.labels.content`),placeholder:a(`${e?"update":"create"}.placeholders.content`),register:I,validation:{maxLength:{value:150,message:a(`${e?"update":"create"}.errors.content`)}},error:U.content,maxLength:150,watchValue:S("content"),classForLabel:"text-gray-400"}),t.jsxs("div",{className:"flex flex-col gap-2",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(O,{id:"newHashtag",label:a(`${e?"update":"create"}.labels.hashtags`),placeholder:a(`${e?"update":"create"}.placeholders.hashtags`),type:"text",register:I,maxLength:12,classForLabel:"!text-gray-400",className:"!flex-1"}),t.jsx("button",{type:"button",onClick:z,disabled:!h||i.length>=5||!Q,className:`
                mt-4 p-2 rounded-full
                ${!h||i.length>=5||!Q?"cursor-not-allowed text-emerald-900":"cursor-pointer text-emerald-500 hover:text-emerald-700"}
              `,children:t.jsx(xe,{size:22})})]}),i.length>0&&t.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:i.map((s,o)=>t.jsxs("span",{className:"px-2 py-1 text-sm rounded bg-sky-800 text-white flex items-center gap-2",children:[s,t.jsx("button",{type:"button",onClick:()=>G(s),className:"text-red-400 hover:text-red-600 font-bold",children:"×"})]},o))})]}),e&&f.some(s=>typeof s=="string")&&t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-2",children:a("update.labels.existingImages")}),t.jsx("div",{className:"flex flex-wrap gap-4",children:f.filter(s=>typeof s=="string").map((s,o)=>t.jsxs("div",{className:"relative",children:[t.jsx("img",{src:s,className:"w-32 h-32 object-cover rounded-lg"}),t.jsx("button",{onClick:()=>W(s),className:"absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center",children:"×"})]},o))})]}),t.jsx(ge,{amount:3,onFilesUpdate:J,classForLabel:"text-gray-400 text-center md:text-left"}),t.jsxs("div",{className:"flex justify-center gap-4",children:[t.jsx(C,{type:"button",onClick:()=>r("/explore"),className:"!bg-gray-600 hover:!bg-gray-700",children:a(`${e?"update":"create"}.buttons.cancel`)}),t.jsx(C,{type:"submit",disabled:E,children:a(E?`${e?"update":"create"}.buttons.${e?"updating":"posting"}`:`${e?"update":"create"}.buttons.${e?"update":"post"}`)}),e&&t.jsx(C,{type:"button",onClick:X,className:"!bg-red-600 hover:!bg-red-700",children:a("update.buttons.delete")})]})]}),e&&t.jsx(he,{isOpen:M,title:a("update.buttons.delete"),message:a("update.errors.confirmDelete"),onConfirm:Y,onCancel:()=>P(!1),confirmLabel:a("update.buttons.delete"),cancelLabel:a("update.buttons.cancel"),color:"error"})]})};export{Ie as default};
