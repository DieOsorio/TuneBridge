import{j as e}from"./mui-DM0ppf3M.js";import{r as u}from"./calendar-BpW-aEGs.js";import{a as P,F as B,b as R,V as K,E as ee,u as T,D as te,G as de,j as se,W as ae,c as ue,x as V,P as Q,X as be,Y as me,k as ve,Z as je}from"./index-Bh6NGL6n.js";import{S as W}from"./index-CpFbDMuT.js";/* empty css                 */import{V as ye,W as we,X as Ne,n as _e,a as he,Y as xe,H as oe,Z as ce,_ as Ce,$ as ke,a0 as Le,a1 as Se}from"./icons-DBDvTy8s.js";import"./reactPlayer-CjHFj7G4.js";import"./lottie-DTlWc_fK.js";import"./gsap-Brfk6Bdo.js";import"./filepond-DcLflJls.js";const fe=({isSelected:t=!1})=>{const i="#a1a1aa",s="#e4e4e7";return e.jsxs("div",{className:`flex items-center gap-3 px-4 py-2 ${t?"bg-sky-700":"bg-transparent"}`,children:[e.jsx(W,{circle:!0,width:40,height:40,baseColor:i,highlightColor:s}),e.jsx("div",{className:"flex flex-col grow",children:e.jsx(W,{height:15,width:"80%",baseColor:i,highlightColor:s})})]})},Oe=({conversation:t,isSelected:i,onClick:s})=>{const{user:a}=P(),{fetchParticipants:o}=B(),{data:g=[],isLoading:p,error:h}=o(t.id),{fetchProfile:r}=R(),m=g==null?void 0:g.find(k=>k.profile_id!==(a==null?void 0:a.id)),{data:c,isLoading:y,error:l}=r((m==null?void 0:m.profile_id)??""),{unreadMessages:x}=K(),{data:f,isLoading:_}=x({conversationId:t.id,profileId:(a==null?void 0:a.id)||""});if(p||y)return e.jsx(fe,{isSelected:i});if(h||l)return e.jsx(ee,{error:(h==null?void 0:h.message)||(l==null?void 0:l.message)||"Unknown error"});const v=t.is_group?t.avatar_url:c==null?void 0:c.avatar_url,j=t.is_group?t.title:c==null?void 0:c.username;return e.jsxs("div",{onClick:()=>s(t.id),className:`flex items-center gap-3 px-4 py-2 cursor-pointer transition-colors ${i?"bg-sky-700":"hover:bg-sky-950 hover:text-white"}`,children:[e.jsxs("div",{className:"relative",children:[v?e.jsx("img",{src:v,alt:"Avatar",className:"w-10 h-10 rounded-full object-cover"}):e.jsx("div",{className:"w-10 h-10 rounded-full bg-neutral-600 flex items-center justify-center text-white text-sm",children:(j==null?void 0:j.charAt(0).toUpperCase())||"?"}),!_&&(f!=null&&f.length)?e.jsx("span",{className:"absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full px-1.5",children:(f==null?void 0:f.length)??0}):null]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:`font-medium truncate ${i&&"text-white"}`,children:j||"Untitled"}),t.last_message&&e.jsx("span",{className:"text-sm text-neutral-400 truncate max-w-[180px]",children:t.last_message})]})]})},Ee=({onSelectConversation:t})=>{const{t:i}=T("chat"),{user:s}=P(),{fetchConversations:a}=te(),{data:o,isLoading:g,error:p}=a((s==null?void 0:s.id)??""),{conversationId:h}=de(),r=se(),[m,c]=u.useState(h),{setIsConversationListVisible:y}=ae();u.useEffect(()=>{!h&&o&&o.length>0?c(o[0].id):c(h)},[h,o]);const l=x=>{c(x),r(`/chat/${x}`),y(!1),t==null||t()};return g?e.jsx(e.Fragment,{children:[...Array(3)].map((x,f)=>e.jsx(fe,{},f))}):p?e.jsx(ee,{error:p.message}):e.jsx("div",{className:"w-full overflow-y-auto h-full bg-gradient-to-l from-gray-900 border-r-2 border-sky-700",children:o!=null&&o.length?o.map(x=>e.jsx(Oe,{conversation:x,isSelected:m===x.id,onClick:()=>l(x.id)},x.id)):e.jsx("p",{className:"text-gray-400 p-4",children:i("list")})})};function Ae({participant:t,isSelf:i,isAdmin:s,menuOpen:a,setMenuOpen:o,setConfirmDialog:g,navigate:p,t:h}){var x;const{fetchProfile:r}=R(),m=(x=r(t.profile_id))==null?void 0:x.data,c=u.useRef(null),[y,l]=u.useState(!1);return u.useEffect(()=>{a===t.profile_id&&c.current&&(c.current.getBoundingClientRect().bottom+140>window.innerHeight?l(!0):l(!1))},[a,t.profile_id]),e.jsxs("li",{className:"flex items-center justify-between py-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Q,{avatar_url:m==null?void 0:m.avatar_url,gender:m==null?void 0:m.gender,className:"!w-8 !h-8"}),e.jsx("span",{className:"text-white font-medium",children:(m==null?void 0:m.username)||t.profile_id}),e.jsx("span",{className:`ml-2 px-2 py-0.5 rounded text-xs ${t.role==="admin"?"bg-sky-700 text-white":"bg-gray-700 text-gray-200"}`,children:h(`groupOverview.role.${t.role}`)})]}),!i&&s&&e.jsxs("div",{className:"relative",children:[e.jsx("button",{ref:c,className:"p-1 rounded-full cursor-pointer hover:bg-gray-800 text-gray-300",onClick:()=>o(a===t.profile_id?null:t.profile_id),"aria-label":h("groupOverview.menu.open"),children:a===t.profile_id?e.jsx(he,{size:20}):e.jsx(xe,{size:20})}),a===t.profile_id&&e.jsx("div",{className:`absolute right-0 w-45 bg-gray-800 border border-gray-700 rounded shadow-lg z-10 ${y?"bottom-full mb-2":"mt-2"}`,children:e.jsxs("ul",{className:"py-1",children:[e.jsx("li",{children:e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-gray-700 text-white",onClick:()=>{p(`/profile/${t.profile_id}`),o(null)},children:h("groupOverview.actions.viewProfile")})}),t.role!=="admin"&&e.jsx("li",{children:e.jsx("button",{className:"w-full text-left border-t border-gray-700 px-4 py-2 text-sm hover:bg-sky-700 text-white",onClick:()=>g({open:!0,action:"promote",participant:t}),children:h("groupOverview.actions.promote")})}),e.jsx("li",{children:e.jsx("button",{className:"w-full text-left border-t border-gray-700 px-4 py-2 text-sm hover:bg-red-700 text-white",onClick:()=>g({open:!0,action:"remove",participant:t}),children:h("groupOverview.actions.remove")})})]})})]})]},t.profile_id)}function Ue({conversation:t,onClose:i}){const{user:s}=P(),[a,o]=u.useState(null),{updateConversation:g}=te(),{fetchParticipants:p,addParticipant:h,removeParticipant:r,updateParticipantRole:m}=B(),{data:c=[]}=p(t.id),{searchProfiles:y}=R(),{t:l}=T("chat"),[x,f]=u.useState(!1),[_,d]=u.useState(t.title||""),[v,j]=u.useState(!1),[k,O]=u.useState(null),L=u.useRef(null),U=se(),[N,S]=u.useState({open:!1,action:null,participant:null}),[C,w]=u.useState(!1),{register:$,watch:X}=ue(),Y=X("searchTerm"),re=c.map(n=>n.profile_id)||[],{data:z,isLoading:H}=y(Y),Z=(z==null?void 0:z.filter(n=>!re.includes(n.id)))||[],F=c.some(n=>n.profile_id===(s==null?void 0:s.id)&&n.role==="admin"),q=async n=>{if(!(!(n!=null&&n[0])||!t.id)&&!v){j(!0);try{const E=n[0];O(URL.createObjectURL(n[0]));const A=await me(E,"chat-group-avatars",t.id,t.avatar_url??void 0,!0);A&&A!==t.avatar_url&&(await g({conversation:t,updates:{avatar_url:A}}),O(null))}finally{j(!1)}}},M=async()=>{f(!1);const n=_.trim();n&&n!==t.title&&await g({conversation:t,updates:{title:n}})},J=async()=>{N.participant&&(N.action==="promote"?await m({conversation_id:t.id,profile_id:N.participant.profile_id,role:"admin"}):N.action==="remove"&&await r({conversation_id:t.id,profile_id:N.participant.profile_id}),S({open:!1,action:null,participant:null}),o(null))},I=async()=>{w(!1),!(!t||!(s!=null&&s.id))&&(await r({conversation_id:t.id,profile_id:s.id}),i())};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-gray-900 rounded-lg shadow-lg p-6 w-full max-w-md relative",children:[e.jsx("button",{onClick:i,className:"absolute cursor-pointer top-2 right-2 text-3xl text-white","aria-label":"Close group overview",children:"âœ•"}),e.jsx("div",{className:"flex justify-start mb-4",children:e.jsxs("button",{onClick:()=>w(!0),className:"text-red-400 cursor-pointer hover:text-red-600 transition text-sm font-semibold flex items-center gap-1",title:l("header.buttons.leaveGroup"),children:[e.jsx(ye,{size:18}),l("header.buttons.leaveGroup")]})}),e.jsx(V,{isOpen:C,title:l("header.leave.title"),message:l("header.leave.groupMessage"),confirmLabel:l("header.leave.confirm"),cancelLabel:l("header.leave.cancel"),onConfirm:I,onCancel:()=>w(!1),color:"error"}),e.jsxs("div",{className:"flex flex-col items-center gap-4 mb-6",children:[e.jsxs("div",{className:"relative",children:[e.jsx(Q,{avatar_url:k||t.avatar_url||void 0,className:"w-20 h-20 bg-amber-600"}),F&&e.jsxs(e.Fragment,{children:[e.jsx("button",{ref:L,className:"absolute bottom-0 right-0 bg-black bg-opacity-50 p-2 rounded-full text-white hover:bg-opacity-80 transition",title:l("groupOverview.avatar.edit"),disabled:v,children:e.jsx(we,{className:"w-5 h-5 cursor-pointer"})}),e.jsx(be,{onFilesUpdate:q,amount:1,triggerRef:L})]})]}),e.jsx("div",{className:"flex items-center gap-2",children:x?e.jsx("input",{type:"text",value:_,onChange:n=>d(n.target.value),onBlur:M,onKeyDown:n=>n.key==="Enter"&&M(),autoFocus:!0,className:"bg-transparent border-b border-sky-500 text-lg font-semibold text-white focus:outline-none",disabled:!F}):e.jsxs(e.Fragment,{children:[e.jsx("h2",{className:"text-xl font-bold text-white",children:_||"Untitled Group"}),F&&e.jsx(Ne,{onClick:()=>f(!0),className:"text-white cursor-pointer hover:text-sky-400 transition text-base",title:l("groupOverview.title.edit")})]})}),F&&e.jsxs("div",{className:"w-full mt-2",children:[e.jsx("input",{type:"text",...$("searchTerm"),placeholder:l("header.search.placeholder"),className:"w-full p-2 rounded-md bg-neutral-800 text-white text-sm border border-neutral-600"}),H&&e.jsx("span",{className:"text-sm text-gray-400 mt-1 block",children:l("header.search.searching")}),e.jsxs("div",{className:"mt-2 flex flex-col gap-2",children:[Z.map(n=>e.jsxs("div",{className:"flex items-center gap-2 bg-gray-800 rounded p-2",children:[e.jsx(Q,{avatar_url:n.avatar_url,gender:n.gender,className:"!w-8 !h-8"}),e.jsx("span",{className:"text-white font-medium",children:n.username}),e.jsx("button",{className:"ml-auto px-2 py-1 bg-sky-700 text-white rounded hover:bg-sky-800 text-xs font-semibold",onClick:()=>h({conversation_id:t.id,profile_id:n.id,role:"member"}),children:l("header.search.toggle")})]},n.id)),!H&&Y&&Z.length===0&&e.jsx("span",{className:"text-sm text-gray-500",children:l("header.search.noResults")})]})]})]}),e.jsxs("div",{children:[e.jsxs("h3",{className:"text-lg font-semibold text-white mb-2 flex items-center gap-2",children:[e.jsx(_e,{})," ",l("groupOverview.participants")]}),e.jsx("ul",{className:"divide-y divide-gray-700",children:[...new Map(c.map(n=>[n.profile_id,n])).values()].map(n=>{const E=(s==null?void 0:s.id)===n.profile_id;return e.jsx(Ae,{participant:n,isSelf:E,isAdmin:F,menuOpen:a,setMenuOpen:o,setConfirmDialog:S,navigate:U,t:l},n.profile_id)})})]}),e.jsx(V,{isOpen:N.open,title:N.action==="remove"?`${l("groupOverview.actions.remove")}?`:`${l("groupOverview.actions.promote")}?`,message:"",confirmLabel:l("groupOverview.actions.confirm"),cancelLabel:l("groupOverview.actions.cancel"),onConfirm:J,onCancel:()=>S({open:!1,action:null,participant:null}),color:N.action==="remove"?"error":"primary"})]})})}const Fe=({conversationId:t})=>{var ne;const{user:i}=P(),s=(i==null?void 0:i.id)??"",{t:a}=T("chat"),{fetchConversation:o,fetchConversations:g,updateConversation:p,deleteConversation:h}=te(),{data:r,isLoading:m,error:c}=o(t??""),{refetch:y}=g(s),{fetchParticipants:l,removeParticipant:x}=B(),f=l(t??"").data;function _(b){return b&&typeof b=="object"&&Array.isArray(b.pages)}let d=[];Array.isArray(f)?d=f:_(f)?d=f.pages.flat():f?(console.error("participantsData unexpected shape",f),d=[]):d=[];const v=d.find(b=>b.profile_id!==s),{fetchProfile:j,searchProfiles:k}=R(),{register:O,watch:L}=ue(),U=L("searchTerm"),{data:N}=k(U),S=d.map(b=>b.profile_id);N==null||N.filter(b=>!S.includes(b.id));const C=(r==null?void 0:r.is_group)??!1;d.some(b=>b.profile_id===s&&b.role==="admin"),u.useRef(null);const w=se(),[$,X]=u.useState(!1),[Y,re]=u.useState(!1),[z,H]=u.useState((r==null?void 0:r.title)??""),[Z,F]=u.useState(!1),[q,M]=u.useState(!1),[J,I]=u.useState(!1),[n,E]=u.useState(!1),[A,G]=u.useState(!1),{isConversationListVisible:D,toggleConversationList:ie}=ae(),le=d.find(b=>b.profile_id===s),pe=async()=>{try{if(M(!1),!r||!s)return;if(C){if(!le){console.error("Current user participant info missing, can't remove");return}await x({conversation_id:r.id,profile_id:s,role:le.role})}else await h(r);w("/chat"),y()}catch(b){console.error("Failed to leave conversation:",b.message)}};if(u.useEffect(()=>{C&&(X(!0),r!=null&&r.title&&H(r.title))},[C,r==null?void 0:r.title]),!t)return e.jsxs("div",{className:"flex items-center gap-4 px-4 py-2 border-b border-sky-600",children:[e.jsx("h2",{className:"text-lg font-semibold",children:a("header.noConversation.title")}),e.jsx("button",{onClick:ie,className:"md:hidden text-white bg-sky-600 text-2xl mr-2 ml-auto rounded-md p-1 cursor-pointer","aria-label":D?"Hide conversation list":"Show conversation list",title:D?"Hide conversation list":"Show conversation list",children:e.jsx(oe,{size:30})})]});if(m)return e.jsx(ve,{});if(c)return e.jsx(ee,{error:c.message});const ge=async()=>{if(r)try{await p({conversation:r,updates:{avatar_url:"/public/group.png",is_group:!0,title:a("header.group.untitled")}})}catch(b){console.error("Failed to convert to group chat:",b.message)}finally{I(!1)}};return e.jsxs("div",{className:"flex flex-col md:flex-row md:items-start md:justify-between gap-2 bg-gradient-to-l from-gray-900 px-4 py-2 border-b-2 border-sky-600",children:[e.jsxs("div",{className:"flex items-center gap-4 w-full relative",children:[r!=null&&r.avatar_url?e.jsx("div",{className:"relative",children:e.jsx("img",{src:r==null?void 0:r.avatar_url,alt:"Group Avatar",className:"w-10 h-10 bg-amber-600 rounded-full object-cover"})}):e.jsx("div",{className:"w-10 h-10 rounded-full bg-neutral-600 flex items-center justify-center text-white text-sm",children:((ne=r==null?void 0:r.title)==null?void 0:ne.charAt(0).toUpperCase())??"?"}),e.jsx("h2",{className:"text-lg font-semibold text-white",children:(r==null?void 0:r.title)??a("header.group.untitled")}),C&&e.jsxs("button",{onClick:()=>E(!0),className:"ml-auto px-2 py-1 cursor-pointer bg-sky-700 text-white rounded hover:bg-sky-800 transition text-xs font-semibold items-center gap-1 hidden md:flex",title:a("header.group.info"),children:[e.jsx(ce,{size:18,className:"inline-block text-base text-gray-300"}),a("header.group.info")]}),!C&&e.jsxs("div",{className:"ml-auto relative flex items-center",children:[e.jsxs("button",{className:"p-1 w-[32px] h-[32px] rounded-full hover:bg-gray-800 cursor-pointer text-gray-300 relative",onClick:()=>G(b=>!b),"aria-label":a("header.menu.open"),children:[e.jsx("span",{className:`absolute inset-0 flex items-center justify-center transition-all duration-200 ease-in-out ${A?"opacity-0 scale-90":"opacity-100 scale-100"}`,children:e.jsx(xe,{size:22})}),e.jsx("span",{className:`absolute inset-0 flex items-center justify-center transition-all duration-200 ease-in-out ${A?"opacity-100 scale-100":"opacity-0 scale-90"}`,children:e.jsx(he,{size:22})})]}),A&&e.jsx("div",{className:"absolute right-7 mt-28 w-48 bg-gray-800 border border-gray-700 rounded shadow-lg z-10",children:e.jsxs("ul",{className:"py-1",children:[e.jsx("li",{children:e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm hover:bg-gray-700 text-white",onClick:()=>{v!=null&&v.profile_id&&w(`/profile/${v.profile_id}`),G(!1)},children:a("groupOverview.actions.viewProfile")})}),e.jsx("li",{children:e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm border-t border-gray-700 hover:bg-sky-700 text-white",onClick:()=>{I(!0),G(!1)},children:a("header.buttons.convertToGroup")})}),e.jsx("li",{children:e.jsx("button",{className:"w-full text-left px-4 py-2 text-sm border-t border-gray-700 hover:bg-red-700 text-white",onClick:()=>{M(!0),G(!1)},children:a("header.buttons.leaveConversation")})})]})})]}),!C&&e.jsx(V,{isOpen:q,title:a("header.leave.title"),message:a("header.leave.directMessage"),confirmLabel:a("header.leave.confirm"),cancelLabel:a("header.leave.cancel"),onConfirm:pe,onCancel:()=>M(!1),color:"error"}),e.jsx(V,{isOpen:J,title:a("header.convert.title"),message:a("header.convert.message"),confirmLabel:a("header.convert.confirm"),cancelLabel:a("header.convert.cancel"),onConfirm:ge,onCancel:()=>I(!1),className:"!bg-emerald-600 hover:!bg-emerald-700"}),e.jsx("button",{onClick:ie,className:"md:hidden text-white bg-sky-600 text-2xl mr-2 ml-auto rounded-md p-1","aria-label":a(D?"header.buttons.hideList":"header.buttons.showList"),title:a(D?"header.buttons.hideList":"header.buttons.showList"),children:e.jsx(oe,{size:30})})]}),C&&e.jsxs("button",{onClick:()=>E(!0),className:"mt-2 mr-auto px-2 py-1 bg-sky-700 text-white rounded hover:bg-sky-800 transition text-xs font-semibold flex items-center gap-1 md:hidden",title:a("header.group.info"),children:[e.jsx(ce,{size:20,className:"inline-block text-base text-gray-300"}),a("header.group.info")]}),n&&r&&e.jsx(Ue,{conversation:r,onClose:()=>E(!1)})]})},Me=t=>{const i=["bg-emerald-600","bg-yellow-700","bg-purple-700","bg-green-800","bg-red-800","bg-pink-800","bg-indigo-500","bg-blue-800","bg-orange-700","bg-teal-600","bg-fuchsia-800","bg-cyan-700","bg-lime-700","bg-rose-800","bg-violet-600"];let s=0;for(let o=0;o<t.length;o++)s=t.charCodeAt(o)+((s<<5)-s);const a=Math.abs(s)%i.length;return i[a]},Ie=({message:t,isMine:i})=>{var U,N,S,C;const{t:s}=T("chat"),{deleteMessage:a,updateMessage:o}=K(),{fetchProfile:g}=R(),{data:p,isLoading:h}=g(t.sender_profile_id),r=Array.isArray(t.delivered_to)&&t.delivered_to.length>0,m=Array.isArray(t.read_by)&&t.read_by.length>0,c=i?"bg-sky-700 text-white":`${Me(t.sender_profile_id)} text-white`,[y,l]=u.useState(!1),[x,f]=u.useState(t.content),[_,d]=u.useState(!1),v=u.useRef(null);u.useEffect(()=>{if(!_)return;const w=$=>{v.current&&!v.current.contains($.target)&&d(!1)};return document.addEventListener("mousedown",w),()=>document.removeEventListener("mousedown",w)},[_]);const j=()=>{l(!0),d(!1)},k=()=>{x.trim()&&x!==t.content&&o({id:t.id,conversation_id:t.conversation_id,updatedFields:{content:x}}),l(!1)},O=()=>{f(t.content),l(!1)},L=()=>{a({id:t.id,conversation_id:t.conversation_id}),d(!1)};return e.jsxs("div",{className:`flex ${i?"justify-end":"justify-start"} space-x-2`,children:[!i&&e.jsxs("div",{className:"flex flex-col items-start max-w-xs",children:[e.jsx("span",{className:"text-xs font-medium text-sky-300 mb-1",children:h?e.jsx(W,{width:80,height:12,baseColor:"#a1a1aa",highlightColor:"#e4e4e7"}):`${(p==null?void 0:p.firstname)||"Unknown"} ${(p==null?void 0:p.lastname)||""}`.trim()}),h?e.jsx(W,{height:32,width:200,baseColor:"#a1a1aa",highlightColor:"#e4e4e7"}):e.jsx("div",{className:`${c} p-2 rounded-lg min-w-[80px] text-center`,children:t.attachment?e.jsxs(e.Fragment,{children:[((U=t.attachment.mime_type)==null?void 0:U.startsWith("image/"))&&e.jsx("img",{src:t.attachment.url,alt:"attachment",className:"max-w-full max-h-60 rounded"}),((N=t.attachment.mime_type)==null?void 0:N.startsWith("audio/"))&&e.jsxs("audio",{controls:!0,className:"w-full",children:[e.jsx("source",{src:t.attachment.url,type:t.attachment.mime_type}),s("message.audioNotSupported")]}),t.content&&t.content]}):t.content})]}),i&&e.jsx("div",{className:"flex flex-col items-end max-w-xs relative",children:e.jsx("div",{className:`${c} p-3 rounded-lg relative pr-6 min-w-[80px]`,children:y?e.jsx("input",{type:"text",value:x,onChange:w=>f(w.target.value),onBlur:k,onKeyDown:w=>{w.key==="Enter"&&k(),w.key==="Escape"&&O()},placeholder:s("message.edit.placeholder"),autoFocus:!0,className:"bg-sky-900 text-white border-b border-sky-400 focus:outline-none w-full px-1 rounded"}):e.jsxs(e.Fragment,{children:[t.attachment?e.jsxs(e.Fragment,{children:[((S=t.attachment.mime_type)==null?void 0:S.startsWith("image/"))&&e.jsx("img",{src:t.attachment.url,alt:"attachment",className:"max-w-full max-h-60 rounded"}),((C=t.attachment.mime_type)==null?void 0:C.startsWith("audio/"))&&e.jsxs("audio",{controls:!0,className:"w-75",children:[e.jsx("source",{src:t.attachment.url,type:t.attachment.mime_type}),s("message.audioNotSupported")]}),t.content&&e.jsx("span",{className:"mr-2",children:t.content})]}):e.jsx("span",{className:"mr-2",children:t.content}),e.jsx("span",{className:"absolute bottom-1 right-1 text-xs text-white",children:m?e.jsx(Ce,{className:"text-green-200",title:"Read"}):r?e.jsx(ke,{className:"text-blue-200",title:"Delivered"}):null}),e.jsx("button",{className:"absolute top-1/2 -translate-y-1/2 right-1 text-white hover:text-sky-400 p-1",onClick:()=>d(w=>!w),"aria-label":"Message options",children:e.jsx(Le,{size:18})}),_&&e.jsxs("div",{ref:v,className:"absolute z-10 right-5 top-6 bg-gray-900 border border-sky-700 rounded shadow-lg py-1 w-37 flex flex-col",children:[e.jsx("button",{className:"px-4 py-2 text-left hover:bg-gray-800 text-sm text-red-400",onClick:L,children:s("message.delete.title")}),e.jsx("div",{className:"border-t border-sky-700"}),e.jsx("button",{className:"px-4 py-2 text-left hover:bg-gray-800 text-sm text-yellow-500",onClick:j,children:s("message.edit.title")})]})]})})})]})},Pe=({messages:t,profileId:i})=>{const s=Array.isArray(t)?t.filter(Boolean):[];return e.jsx("div",{className:"space-y-4",children:s.length>0&&s.map(a=>{const o=a.sender_profile_id===i;return e.jsx(Ie,{message:a,isMine:o},a.id||a.tempId||Math.random())})})},Re=({conversationId:t,senderId:i})=>{const{t:s}=T("chat"),[a,o]=u.useState(""),{insertMessage:g}=K(),{insertMessageAttachment:p}=je(),{fetchParticipants:h}=B(),{data:r=[]}=h(t),m=u.useRef(null),[c,y]=u.useState(!1),l=async d=>{if(d.preventDefault(),!a.trim())return;const v=(r==null?void 0:r.map(j=>j.profile_id).filter(j=>j!==i))??[];await g({content:a,sender_profile_id:i,conversation_id:t,delivered_to:v}),o("")},x=d=>{d.key==="Enter"&&!d.shiftKey&&(d.preventDefault(),l(d))},f=()=>{var d;(d=m.current)==null||d.click()},_=async d=>{if(!d.target.files||d.target.files.length===0)return;const v=d.target.files[0];y(!0);try{const j=await me(v,"message-attachments",t);if(!j){alert(s("uploadFailed")),y(!1);return}const k=await p({conversation_id:t,profile_id:i,url:j,mime_type:v.type}),O=(r==null?void 0:r.map(L=>L.profile_id).filter(L=>L!==i))??[];await g({content:"",sender_profile_id:i,conversation_id:t,delivered_to:O,attachment_id:k.id}),o("")}catch(j){console.error("Upload or insert failed:",j),alert(s("uploadFailed"))}finally{y(!1),m.current&&(m.current.value="")}};return e.jsxs("form",{onSubmit:l,className:"flex items-center space-x-2",children:[e.jsx("textarea",{rows:1,value:a,onChange:d=>o(d.target.value),onKeyDown:x,placeholder:s("input.placeholder"),className:"flex-1 resize-none rounded-lg border border-neutral-700 bg-neutral-950 text-white p-2 outline-none focus:ring-1 focus:ring-neutral-500",disabled:c}),e.jsx("button",{type:"button",onClick:f,title:s("input.attachFile"),disabled:c,className:"text-white hover:text-sky-400 transition text-xl p-2",children:e.jsx(Se,{})}),e.jsx("input",{type:"file",ref:m,onChange:_,className:"hidden",accept:"image/jpeg,image/png,image/gif,image/webp,image/svg+xml,audio/mpeg,audio/wav,audio/ogg,audio/webm,audio/aac,audio/flac,audio/mp4,audio/x-wav,audio/x-m4a"}),e.jsx("button",{type:"submit",className:"bg-sky-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-sky-700 transition",disabled:c,children:s(c?"input.uploading":"input.button")})]})},Te=()=>{const{conversationId:t}=de(),{user:i}=P(),s=!!t&&!!(i!=null&&i.id),{fetchMessages:a,markMessagesAsRead:o,unreadMessages:g,messagesRealtime:p}=K();p(t??"");const{data:h=[]}=a(t??""),{data:r=[]}=g({conversationId:t??"",profileId:(i==null?void 0:i.id)??""});u.useEffect(()=>{if(s&&r&&r.length>0&&o){const c=r.map(y=>y.id);o({messageIds:c,profileId:i.id,conversationId:t})}},[s,r,o,i==null?void 0:i.id,t]);const m=Array.isArray(h)?h.filter(c=>c&&c.sender_profile_id):[];return e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsx(Fe,{conversationId:t}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4",children:e.jsx(Pe,{messages:s?m:[],profileId:(i==null?void 0:i.id)??""})}),e.jsx("div",{className:"p-4",children:t&&(i==null?void 0:i.id)&&e.jsx(Re,{conversationId:t,senderId:i.id})})]})},Ye=()=>{const{isConversationListVisible:t,setIsConversationListVisible:i}=ae(),s=()=>{i(!1)};return e.jsxs("div",{className:"flex h-screen relative",children:[e.jsx("div",{className:`fixed md:static top-0 left-0 h-full bg-gray-900 z-50 transition-transform duration-300 ease-in-out
          ${t?"translate-x-0 w-3/5":"-translate-x-full"} md:translate-x-0 md:w-1/4`,children:e.jsx(Ee,{onSelectConversation:s})}),e.jsx("div",{className:"flex-1 md:w-3/4 w-full h-full overflow-hidden",children:e.jsx(Te,{})})]})};export{Ye as default};
