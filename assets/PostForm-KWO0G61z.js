import{j as t}from"./mui-B-xP7mtj.js";import{r as v}from"./filepond-C4Y8_Bzv.js";import{u as te}from"./index.esm-B1e87uze.js";import{G as ae,H as se,s as F,u as re,a as oe,v as le,d as ne,I as ie,f as de,J as ce,e as me}from"./index-Drs9Rx39.js";import{B as C}from"./Button-CbZ7oUI_.js";import{I as R}from"./Input-DJlOEIMy.js";import{T as ue}from"./Textarea-ywiaY8NM.js";import{I as pe}from"./ImageUploader-BhF5QjZI.js";import{E as ge}from"./ErrorMessage-B2u091H8.js";import{C as he}from"./ConfirmDialog-DxIiB_6a.js";import{z as fe}from"./icons-r1d5ly4y.js";import"./reactPlayer-xbeEqQf7.js";import"./lottie-Qij33HW6.js";const xe=()=>{const a=ae();return se({mutationFn:async({file:d,userId:e,postId:r,filename:f})=>{const c=`${e}/${r}/${f}`,{data:w,error:g}=await F.storage.from("post-media").upload(c,d,{cacheControl:"3600",upsert:!0});if(g)throw new Error(g.message);const{data:m,error:y}=F.storage.from("post-media").getPublicUrl(c);if(y)throw new Error(`Get public URL failed: ${y.message}`);return m!=null&&m.publicUrl?m.publicUrl:(console.warn("getPublicUrl did not return a valid publicUrl",m),null)},onMutate:async({file:d,userId:e,postId:r,filename:f})=>{await a.cancelQueries({queryKey:["posts"]});const c=a.getQueryData(["posts"]),w={id:`temp-${Date.now()}`,url:URL.createObjectURL(d),created_at:new Date().toISOString(),userId:e,postId:r,filename:f};return a.setQueryData(["posts"],(g=[])=>[...g,w]),{previousDetails:c}},onError:(d,e,r)=>{r!=null&&r.previousDetails&&a.setQueryData(["posts"],r.previousDetails)},onSettled:(d,e)=>{a.invalidateQueries({queryKey:["posts"]})}})},Ce=()=>{var O;const{t:a}=re("posts"),{user:d}=oe(),{postId:e}=le(),r=ne(),{createPost:f,updatePost:c,fetchPost:w,deletePost:g}=ie(),m=xe(),{upsertHashtag:y}=de(),{getHashtagsByPostId:q,upsertPostHashtag:A,deletePostHashtags:B}=ce(),[x,j]=v.useState([]),[i,$]=v.useState([]),[M,P]=v.useState(!1),{register:I,handleSubmit:T,setValue:H,watch:S,reset:V,formState:{errors:U,isSubmitting:E}}=te(),h=(O=S("newHashtag"))==null?void 0:O.trim(),{data:l,isLoading:z,error:k}=e?w(e):{data:null,isLoading:!1,error:null},{data:N}=e?q(e):{data:[]};v.useEffect(()=>{if(e&&l&&(H("title",l.title),H("content",l.content),j(l.images_urls||[]),N)){const s=N.map(o=>o.hashtags.name);$(s)}},[l,N,e]);const G=()=>{h&&!i.includes(h)&&i.length<5&&($([...i,h]),H("newHashtag",""))},K=s=>{$(i.filter(o=>o!==s))},J=s=>{j(o=>[...o,...s])},W=async s=>{const o=s.split("/").pop();await F.storage.from("post-media").remove([o]);const b=x.filter(D=>D!==s);await c({id:l.id,updatedPost:{...l,images_urls:b}}),j(b)},X=()=>P(!0),Y=async()=>{await g(e),r(`/profile/${l.profile_id}`),P(!1)},Z=async s=>{const{newHashtag:o,...b}=s,D=i.map(n=>n.trim()).filter(Boolean);try{let n;if(e){const u=await Promise.all(x.map(async(p,L)=>{if(typeof p=="string")return p;const _=`${Date.now()}-${L}-${p.name}`;return await m.mutateAsync({file:p,userId:l.profile_id,postId:e,filename:_})}));await c({id:e,updatedPost:{...b,images_urls:u}}),await B({post_id:e}),n=l}else{n=await f({...b,profile_id:d.id,images_urls:[]});const u=await Promise.all(x.map(async(p,L)=>{const _=`${Date.now()}-${L}-${p.name}`;return await m.mutateAsync({file:p,userId:d.id,postId:n.id,filename:_})}));await c({id:n.id,updatedPost:{images_urls:u}})}const ee=await Promise.all(D.map(u=>y({name:u})));await Promise.all(ee.map(u=>A({post_id:n.id,hashtag_id:u.id}))),V(),j([]),$([]),r(e?`/profile/${n.profile_id}`:"/explore")}catch(n){console.error("Post error:",n.message)}};if(z)return t.jsx(me,{});if(k)return t.jsx(ge,{error:k.message});const Q=/^#[\w-]+$/.test(h||"");return t.jsxs(t.Fragment,{children:[t.jsx("h2",{className:"text-2xl text-yellow-600 font-semibold text-center mb-4",children:a(e?"update.title":"create.title")}),t.jsxs("form",{onSubmit:T(Z),className:"space-y-6 bg-gradient-to-r from-gray-900 p-6 rounded-lg shadow-md max-w-xl mx-auto",children:[t.jsx(R,{id:"title",label:a(`${e?"update":"create"}.labels.title`),placeholder:a(`${e?"update":"create"}.placeholders.title`),maxLength:30,register:I,validation:{required:a(`${e?"update":"create"}.errors.title`)},error:U.title,classForLabel:"text-gray-400 text-center md:text-left"}),t.jsx(ue,{id:"content",label:a(`${e?"update":"create"}.labels.content`),placeholder:a(`${e?"update":"create"}.placeholders.content`),register:I,validation:{maxLength:{value:150,message:a(`${e?"update":"create"}.errors.content`)}},error:U.content,maxLength:150,watchValue:S("content"),classForLabel:"text-gray-400"}),t.jsxs("div",{className:"flex flex-col gap-2",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(R,{id:"newHashtag",label:a(`${e?"update":"create"}.labels.hashtags`),placeholder:a(`${e?"update":"create"}.placeholders.hashtags`),type:"text",register:I,maxLength:12,classForLabel:"!text-gray-400",className:"!flex-1"}),t.jsx("button",{type:"button",onClick:G,disabled:!h||i.length>=5||!Q,className:`
                mt-4 p-2 rounded-full
                ${!h||i.length>=5||!Q?"cursor-not-allowed text-emerald-900":"cursor-pointer text-emerald-500 hover:text-emerald-700"}
              `,children:t.jsx(fe,{size:22})})]}),i.length>0&&t.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:i.map((s,o)=>t.jsxs("span",{className:"px-2 py-1 text-sm rounded bg-sky-800 text-white flex items-center gap-2",children:[s,t.jsx("button",{type:"button",onClick:()=>K(s),className:"text-red-400 hover:text-red-600 font-bold",children:"×"})]},o))})]}),e&&x.some(s=>typeof s=="string")&&t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-2",children:a("update.labels.existingImages")}),t.jsx("div",{className:"flex flex-wrap gap-4",children:x.filter(s=>typeof s=="string").map((s,o)=>t.jsxs("div",{className:"relative",children:[t.jsx("img",{src:s,className:"w-32 h-32 object-cover rounded-lg"}),t.jsx("button",{onClick:()=>W(s),className:"absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center",children:"×"})]},o))})]}),t.jsx(pe,{amount:3,onFilesUpdate:J,classForLabel:"text-gray-400 text-center md:text-left"}),t.jsxs("div",{className:"flex justify-center gap-4",children:[t.jsx(C,{type:"button",onClick:()=>r("/explore"),className:"!bg-gray-600 hover:!bg-gray-700",children:a(`${e?"update":"create"}.buttons.cancel`)}),t.jsx(C,{type:"submit",disabled:E,children:a(E?`${e?"update":"create"}.buttons.${e?"updating":"posting"}`:`${e?"update":"create"}.buttons.${e?"update":"post"}`)}),e&&t.jsx(C,{type:"button",onClick:X,className:"!bg-red-600 hover:!bg-red-700",children:a("update.buttons.delete")})]})]}),e&&t.jsx(he,{isOpen:M,title:a("update.buttons.delete"),message:a("update.errors.confirmDelete"),onConfirm:Y,onCancel:()=>P(!1),confirmLabel:a("update.buttons.delete"),cancelLabel:a("update.buttons.cancel"),color:"error"})]})};export{Ce as default};
